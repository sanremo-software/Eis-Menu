<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Food & Drinks ‚Äì QR Tischbestellung</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --primary: #e53935;
            --primary-dark: #b71c1c;
            --bg: #fff8f2;
            --card-bg: #ffffff;

            --tab-portions: #ffb300;
            --tab-kids: #ff4081;
            --tab-eis: #29b6f6;
            --tab-food: #66bb6a;
            --tab-drinks: #ab47bc;
        }
        * { box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: radial-gradient(circle at top, #fffdf8 0%, #fff3e0 35%, #ffe0b2 100%);
            margin: 0;
            padding: 0;
            color: #222;
        }

        /* HEADER */
        .header {
            width: 100%;
            background: linear-gradient(135deg, #000000 0%, #111111 40%, #000000 100%);
            padding: 12px 0 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 2px 8px rgba(0,0,0,0.35);
        }
        .header-inner {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 0 10px;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header-logo {
            max-width: 100%;
            max-height: 80px;
            height: auto;
            width: auto;
            object-fit: contain;
        }
        .header-title {
            font-size: 20px;
            font-weight: 600;
            color: #fdd835;
            letter-spacing: 0.5px;
            text-align: left;
        }
        .lang-box {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
            color: #fff;
            font-size: 12px;
        }
        .lang-select {
            padding: 4px 6px;
            border-radius: 999px;
            border: 1px solid #555;
            background: #222;
            color: #fff;
            font-size: 12px;
        }
        @media (max-width: 600px) {
            .header-inner {
                flex-direction: column;
                align-items: flex-start;
            }
            .lang-box {
                align-items: flex-start;
            }
            .header-title {
                font-size: 17px;
            }
        }

        .container {
            padding: 15px;
            max-width: 960px;
            margin: 0 auto 25px auto;
        }
        .section-title {
            font-size: 18px;
            margin-top: 18px;
            margin-bottom: 8px;
            border-left: 4px solid var(--primary);
            padding-left: 8px;
        }
        .card {
            background: var(--card-bg);
            padding: 14px;
            border-radius: 14px;
            margin-bottom: 14px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.06);
            border: 1px solid rgba(255,255,255,0.8);
        }
        label {
            font-size: 14px;
            display: block;
            margin-top: 5px;
            margin-bottom: 3px;
        }
        select, input {
            width: 100%;
            padding: 9px 10px;
            font-size: 14px;
            border-radius: 10px;
            border: 1px solid #d0d0d0;
            background: #fff;
        }
        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(229,57,53,0.2);
        }
        .btn {
            background: var(--primary);
            color: #fff;
            padding: 10px;
            display: inline-block;
            text-align: center;
            border-radius: 999px;
            text-decoration: none;
            margin-top: 12px;
            font-size: 16px;
            border: none;
            cursor: pointer;
            width: 100%;
            transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.1s ease;
        }
        .btn:hover {
            background: var(--primary-dark);
            box-shadow: 0 4px 10px rgba(0,0,0,0.18);
            transform: translateY(-1px);
        }
        .btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
        }
        .btn:disabled {
            background: #c5c5c5;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        #warenkorb {
            background: rgba(255,255,255,0.98);
            padding: 14px;
            border-radius: 16px;
            margin-top: 20px;
            box-shadow: 0 8px 18px rgba(0,0,0,0.08);
            border: 1px solid rgba(255,255,255,0.9);
        }
        #liste-items div {
            padding: 6px 0;
            border-bottom: 1px dashed #e0e0e0;
            font-size: 14px;
        }
        .line-item {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: center;
        }
        .item-info {
            flex: 1;
        }
        .btn-remove {
            background: #ff7043;
            border: none;
            color: #fff;
            padding: 4px 9px;
            border-radius: 999px;
            font-size: 11px;
            cursor: pointer;
        }
        .btn-remove:hover {
            background: #f4511e;
        }
        .total {
            font-weight: bold;
            font-size: 16px;
            margin-top: 10px;
            text-align: right;
        }
        .small {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }

        /* TABS */
        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
        }
        .tab-btn {
            flex: 1 1 auto;
            padding: 7px 8px;
            font-size: 13px;
            border-radius: 999px;
            border: 1px solid #ddd;
            background: #ffffff;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #444;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .tab-btn.active {
            color: #fff;
            border-color: transparent;
            box-shadow: 0 3px 9px rgba(0,0,0,0.15);
        }
        .tab-portions.active { background: var(--tab-portions); }
        .tab-kids.active     { background: var(--tab-kids); }
        .tab-eis.active      { background: var(--tab-eis); }
        .tab-food.active     { background: var(--tab-food); }
        .tab-drinks.active   { background: var(--tab-drinks); }

        .tab-portions { border-color: rgba(255,179,0,0.6); }
        .tab-kids     { border-color: rgba(255,64,129,0.5); }
        .tab-eis      { border-color: rgba(41,182,246,0.5); }
        .tab-food     { border-color: rgba(102,187,106,0.6); }
        .tab-drinks   { border-color: rgba(171,71,188,0.6); }

        @media (max-width: 600px) {
            .tab-btn {
                font-size: 11px;
                padding: 6px 6px;
            }
        }

        /* Chef-Bereich */
        .admin-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        .btn-logout {
            background: #757575;
            border: none;
            color: #fff;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
        }
        .btn-logout:hover {
            background: #616161;
        }
        .admin-order {
            border-bottom: 1px dashed #ddd;
            padding: 6px 0;
            font-size: 12px;
        }
        .btn-small {
            background: #c62828;
            border: none;
            color: #fff;
            padding: 3px 7px;
            border-radius: 999px;
            font-size: 11px;
            cursor: pointer;
            margin-top: 3px;
        }
        .btn-small:hover {
            background: #b71c1c;
        }

        /* Rechtlicher Hinweis */
        .legal-box {
            font-size: 11px;
            color: #777;
            margin: 10px auto 0 auto;
            max-width: 960px;
            text-align: left;
            line-height: 1.5;
            padding: 0 12px 18px 12px;
        }
        .legal-box details {
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            padding: 8px 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .legal-box summary {
            cursor: pointer;
        }
    </style>
</head>

<body>

<header class="header">
    <div class="header-inner">
        <div class="header-left">
            <!-- mete o ficheiro do logo horizontal na mesma pasta -->
            <img src="sanremo-digital-systems-horizontal.png"
                 alt="Sanremo Digital Systems Logo"
                 class="header-logo">
            <div class="header-title" data-i18n="headerTitle">
                Digitaler QR-Tischservice ‚Äì Internes Bestellsystem
            </div>
        </div>
        <div class="lang-box">
            <span data-i18n="langLabel">Sprache / Language / Lingua:</span>
            <select id="lang-select" class="lang-select">
                <option value="de">Deutsch</option>
                <option value="pt">Portugu√™s</option>
                <option value="it">Italiano</option>
            </select>
        </div>
    </div>
</header>

<div class="container">

    <!-- TISCHWAHL -->
    <div class="card">
        <h2 class="section-title" data-i18n="tableSectionTitle">Tisch w√§hlen</h2>
        <label for="tisch" data-i18n="tableLabel">Tischnummer ausw√§hlen:</label>
        <select id="tisch">
            <option value="" data-i18n="tablePlaceholder">Tisch ausw√§hlen‚Ä¶</option>
        </select>
        <div class="small" data-i18n="tableInfo">Verf√ºgbar: Tisch 1 bis 33</div>
    </div>

    <!-- PRODUKTWAHL -->
    <div class="card">
        <h2 class="section-title" data-i18n="productSectionTitle">Produkt w√§hlen</h2>

        <div class="tabs">
            <button class="tab-btn tab-portions active" data-group="portions" data-i18n="tabPortions">
                Portionen
            </button>
            <button class="tab-btn tab-kids" data-group="kids" data-i18n="tabKids">
                Kinder
            </button>
            <button class="tab-btn tab-eis" data-group="eis" data-i18n="tabEis">
                Eisbecher &amp; Spaghetti
            </button>
            <button class="tab-btn tab-food" data-group="food" data-i18n="tabFood">
                Snacks &amp; Waffeln
            </button>
            <button class="tab-btn tab-drinks" data-group="drinks" data-i18n="tabDrinks">
                Getr√§nke
            </button>
        </div>

        <label for="produkt" data-i18n="productLabel">Produkt:</label>
        <select id="produkt">
            <option value="" data-i18n="productPlaceholder">Bitte w√§hlen‚Ä¶</option>
        </select>

        <!-- Sortenwahl nur f√ºr Portionen (optional) -->
        <div id="geschmack-box" style="margin-top:12px; display:none;">
            <label data-i18n="flavourLabel">Sorten (optional, bis zu 3 w√§hlen):</label>
            <select id="geschmack1"></select>
            <select id="geschmack2" style="margin-top:6px;"></select>
            <select id="geschmack3" style="margin-top:6px;"></select>
            <div class="small" data-i18n="flavourInfo">
                Wenn keine Sorten gew√§hlt werden, kommt die Portion in unserer Standardmischung.
            </div>
        </div>

        <!-- Sahne-Option -->
        <div id="sahne-box" style="margin-top:8px; display:none;">
            <label for="sahne" data-i18n="creamLabel">Sahne (+1,20 ‚Ç¨):</label>
            <select id="sahne">
                <option value="" data-i18n="creamPlaceholder">Bitte ausw√§hlen (optional)</option>
                <option value="mit Sahne" data-i18n="creamWith">mit Sahne (+1,20 ‚Ç¨)</option>
                <option value="ohne Sahne" data-i18n="creamWithout">ohne Sahne</option>
            </select>
            <div class="small" data-i18n="creamInfo">
                Wenn nichts gew√§hlt wird, bereiten wir es wie auf der Karte zu.
            </div>
        </div>

        <label for="bemerkung" style="margin-top:8px;" data-i18n="noteLabel">
            Bemerkung (optional):
        </label>
        <input id="bemerkung" type="text"
               placeholder="z.B. ohne Sahne, wenig So√üe ‚Ä¶"
               data-i18n-placeholder="notePlaceholder">

        <button class="btn" onclick="addToCart()" data-i18n="btnAddToCart">
            Zum Warenkorb hinzuf√ºgen
        </button>
    </div>

    <!-- WARENKORB -->
    <div id="warenkorb">
        <h2 class="section-title" data-i18n="cartTitle">üß∫ Warenkorb</h2>
        <div id="liste-items"></div>
        <div class="total" id="gesamt">Gesamt: 0,00 ‚Ç¨</div>

        <button id="btn-whatsapp" class="btn" onclick="sendWhatsApp()" disabled data-i18n="btnWhatsApp">
            Bestellung per WhatsApp senden üì≤
        </button>

        <!-- Drucker: sichtbar nur para o chefe (ativado no adminLogin) -->
        <button id="btn-print"
                class="btn"
                style="margin-top:8px; background:#007b83; display:none;"
                onclick="printOrder()"
                disabled
                data-i18n="btnPrint">
            Bestellung drucken üñ®
        </button>

        <button class="btn"
                style="margin-top:8px; background:#555;"
                onclick="resetTable()"
                data-i18n="btnResetTable">
            Tisch l√∂schen / neue G√§ste
        </button>

        <div class="small" style="margin-top:6px;" id="gps-info" data-i18n="gpsInfoChecking">
            GPS wird gepr√ºft‚Ä¶ bitte Standort-Freigabe erlauben.
        </div>
    </div>

    <!-- CHEF LOGIN -->
    <div class="card" id="admin-login-card">
        <h2 class="section-title" data-i18n="adminSectionTitle">Chef-Bereich</h2>
        <p class="small" data-i18n="adminInfo">
            Zugang nur f√ºr Inhaber / Gesch√§ftsf√ºhrer. Hier werden alle gesendeten Bestellungen
            gespeichert und Produkte / Preise angepasst.
        </p>
        <label for="admin-password" data-i18n="adminPasswordLabel">Chef-Passwort:</label>
        <input id="admin-password" type="password" placeholder="Passwort eingeben"
               data-i18n-placeholder="adminPasswordPlaceholder">
        <button class="btn" onclick="adminLogin()" data-i18n="btnAdminLogin">
            Chef-Login
        </button>
    </div>

    <!-- CHEF PANEL -->
    <div class="card" id="admin-panel" style="display:none;">
        <div class="admin-header">
            <h2 class="section-title" style="margin-bottom:0;" data-i18n="adminOrdersTitle">
                Gespeicherte Bestellungen
            </h2>
            <button class="btn-logout" onclick="adminLogout()" data-i18n="btnLogout">
                Logout
            </button>
        </div>
        <div class="small" style="margin-top:4px;" data-i18n="adminOrdersInfo">
            Hier werden alle Bestellungen gespeichert, die per WhatsApp gesendet oder gedruckt wurden.
            Der Chef kann einzelne Bestellungen oder alle Eintr√§ge l√∂schen.
        </div>
        <div id="admin-orders-list" style="margin-top:10px;"></div>
        <button class="btn"
                style="margin-top:10px; background:#c62828;"
                onclick="clearAllOrders()"
                data-i18n="btnClearOrders">
            Alle Bestellungen l√∂schen
        </button>

        <hr style="margin:18px 0; border:none; border-top:1px solid #eee;">

        <!-- PRODUKT-VERWALTUNG -->
        <h3 class="section-title" style="border-left-color:#00796b;" data-i18n="adminEditProductsTitle">
            Produkte bearbeiten
        </h3>
        <label for="admin-product-select" data-i18n="adminProductSelectLabel">Bestehendes Produkt w√§hlen:</label>
        <select id="admin-product-select">
            <option value="" data-i18n="adminProductSelectPlaceholder">Produkt w√§hlen‚Ä¶</option>
        </select>
        <div class="small" data-i18n="adminProductInfo">
            √Ñnderungen werden lokal im Browser gespeichert (pro Ger√§t / Standort).
        </div>

        <label for="admin-prod-name" data-i18n="adminProdNameLabel">Name:</label>
        <input id="admin-prod-name" type="text">

        <label for="admin-prod-price" data-i18n="adminProdPriceLabel">Preis (‚Ç¨):</label>
        <input id="admin-prod-price" type="number" step="0.01">

        <label for="admin-prod-group" data-i18n="adminProdGroupLabel">Gruppe:</label>
        <select id="admin-prod-group">
            <option value="portions" data-i18n="groupPortions">Portionen</option>
            <option value="kids" data-i18n="groupKids">Kinder</option>
            <option value="eis" data-i18n="groupEis">Eisbecher & Spaghetti</option>
            <option value="food" data-i18n="groupFood">Snacks & Waffeln</option>
            <option value="drinks" data-i18n="groupDrinks">Getr√§nke</option>
        </select>

        <label for="admin-prod-type" data-i18n="adminProdTypeLabel">Art:</label>
        <select id="admin-prod-type">
            <option value="normal" data-i18n="typeNormal">Normal</option>
            <option value="cup3" data-i18n="typeCup3">Portion (Sortenwahl)</option>
        </select>

        <label style="margin-top:6px;">
            <input type="checkbox" id="admin-prod-sahne">
            <span data-i18n="adminProdCreamCheckbox">Sahne-Option (+1,20 ‚Ç¨) erlauben</span>
        </label>

        <button class="btn" style="margin-top:10px;" onclick="saveExistingProduct()" data-i18n="btnSaveProduct">
            Ausgew√§hltes Produkt speichern
        </button>
        <button class="btn"
                style="margin-top:6px; background:#c62828;"
                onclick="deleteExistingProduct()"
                data-i18n="btnDeleteProduct">
            Ausgew√§hltes Produkt l√∂schen
        </button>

        <h3 class="section-title" style="border-left-color:#0288d1; margin-top:20px;"
            data-i18n="adminNewProductTitle">
            Neues Produkt hinzuf√ºgen
        </h3>
        <label for="new-prod-id" data-i18n="newProdIdLabel">Produkt-Nr. (z.B. 701):</label>
        <input id="new-prod-id" type="number">

        <label for="new-prod-name" data-i18n="newProdNameLabel">Name:</label>
        <input id="new-prod-name" type="text">

        <label for="new-prod-price" data-i18n="newProdPriceLabel">Preis (‚Ç¨):</label>
        <input id="new-prod-price" type="number" step="0.01">

        <label for="new-prod-group" data-i18n="newProdGroupLabel">Gruppe:</label>
        <select id="new-prod-group">
            <option value="portions" data-i18n="groupPortions">Portionen</option>
            <option value="kids" data-i18n="groupKids">Kinder</option>
            <option value="eis" data-i18n="groupEis">Eisbecher & Spaghetti</option>
            <option value="food" data-i18n="groupFood">Snacks & Waffeln</option>
            <option value="drinks" data-i18n="groupDrinks">Getr√§nke</option>
        </select>

        <label for="new-prod-type" data-i18n="newProdTypeLabel">Art:</label>
        <select id="new-prod-type">
            <option value="normal" data-i18n="typeNormal">Normal</option>
            <option value="cup3" data-i18n="typeCup3">Portion (Sortenwahl)</option>
        </select>

        <label style="margin-top:6px;">
            <input type="checkbox" id="new-prod-sahne">
            <span data-i18n="newProdCreamCheckbox">Sahne-Option (+1,20 ‚Ç¨) erlauben</span>
        </label>

        <button class="btn" style="margin-top:10px;" onclick="addNewProduct()" data-i18n="btnCreateProduct">
            Neues Produkt anlegen
        </button>

        <!-- SORTEN-VERWALTUNG -->
        <h3 class="section-title" style="border-left-color:#6a1b9a; margin-top:20px;"
            data-i18n="adminFlavoursTitle">
            Eissorten verwalten
        </h3>
        <div id="sorten-list" class="small" style="margin-bottom:8px;"></div>

        <label for="new-sorte" data-i18n="newFlavourLabel">Neue Sorte:</label>
        <input id="new-sorte" type="text" placeholder="z.B. Stracciatella Light"
               data-i18n-placeholder="newFlavourPlaceholder">

        <button class="btn" style="margin-top:6px;" onclick="addNewSorte()" data-i18n="btnAddFlavour">
            Sorte hinzuf√ºgen
        </button>

        <!-- RECHTLICHER HINWEIS NUR F√úR CHEF -->
        <div class="legal-box">
            <details>
                <summary><strong data-i18n="legalSummary">Rechtlicher Hinweis (anklicken)</strong></summary>
                <div id="legal-text">
                    <!-- texto √© inserido via JavaScript dependendo da l√≠ngua -->
                </div>
            </details>
        </div>

    </div>

</div>

<script>
/* CONFIG B√ÅSICA */
const WHATSAPP_NUMMER = "4917672809926";
const ADMIN_PASSWORD = "1234";
const SAHNE_AUFSCHLAG = 1.20;

/* Koordinaten deines Caf√©s (anpassen wenn n√∂tig) */
const CAFE_LAT = 51.051;
const CAFE_LNG = 8.392;
const MAX_DIST_KM = 1.5;

let gpsOk = false;
let adminOrders = [];
let isAdmin = false;

/* ESQUELETO: sem produtos por defeito */
const BASE_PRODUCTS = {};
let PRODUCTS = JSON.parse(JSON.stringify(BASE_PRODUCTS));

/* Eissorten Standard (podes mudar no painel do chefe) */
let SORTEN = [
    "Vanille","Amarena","Joghurt","Nuss","Schokolade","Stracciatella",
    "After Eight","Schlumpfeis","Malaga","Walnuss","Cookies","Zitrone",
    "Erdbeere","Mango","Banane","Himbeere","Limette",
    "Dunkle Schokolade","Paw Patrol","Snickers","Pistazien"
];

/* Tradu√ß√µes DE / PT / IT */
let currentLang = "de";

const i18n = {
    de: {
        headerTitle: "Digitaler QR-Tischservice ‚Äì Internes Bestellsystem",
        langLabel: "Sprache / Language / Lingua:",
        tableSectionTitle: "Tisch w√§hlen",
        tableLabel: "Tischnummer ausw√§hlen:",
        tablePlaceholder: "Tisch ausw√§hlen‚Ä¶",
        tableInfo: "Verf√ºgbar: Tisch 1 bis 33",

        productSectionTitle: "Produkt w√§hlen",
        tabPortions: "Portionen",
        tabKids: "Kinder",
        tabEis: "Eisbecher & Spaghetti",
        tabFood: "Snacks & Waffeln",
        tabDrinks: "Getr√§nke",
        productLabel: "Produkt:",
        productPlaceholder: "Bitte w√§hlen‚Ä¶",

        flavourLabel: "Sorten (optional, bis zu 3 w√§hlen):",
        flavourInfo: "Wenn keine Sorten gew√§hlt werden, kommt die Portion in unserer Standardmischung.",
        creamLabel: "Sahne (+1,20 ‚Ç¨):",
        creamPlaceholder: "Bitte ausw√§hlen (optional)",
        creamWith: "mit Sahne (+1,20 ‚Ç¨)",
        creamWithout: "ohne Sahne",
        creamInfo: "Wenn nichts gew√§hlt wird, bereiten wir es wie auf der Karte zu.",
        noteLabel: "Bemerkung (optional):",
        notePlaceholder: "z.B. ohne Sahne, wenig So√üe ‚Ä¶",
        btnAddToCart: "Zum Warenkorb hinzuf√ºgen",

        cartTitle: "üß∫ Warenkorb",
        btnWhatsApp: "Bestellung per WhatsApp senden üì≤",
        btnPrint: "Bestellung drucken üñ®",
        btnResetTable: "Tisch l√∂schen / neue G√§ste",
        gpsInfoChecking: "GPS wird gepr√ºft‚Ä¶ bitte Standort-Freigabe erlauben.",
        gpsInfoOk: "Standort OK ‚Äì Bestellung per WhatsApp ist m√∂glich.",
        gpsInfoFar: "Sie sind zu weit vom Standort entfernt ‚Äì Bestellung per WhatsApp nicht m√∂glich.",
        gpsInfoError: "Standort konnte nicht bestimmt werden ‚Äì bitte GPS erlauben.",

        adminSectionTitle: "Chef-Bereich",
        adminInfo: "Zugang nur f√ºr Inhaber / Gesch√§ftsf√ºhrer. Hier werden alle gesendeten Bestellungen gespeichert und Produkte / Preise angepasst.",
        adminPasswordLabel: "Chef-Passwort:",
        adminPasswordPlaceholder: "Passwort eingeben",
        btnAdminLogin: "Chef-Login",

        adminOrdersTitle: "Gespeicherte Bestellungen",
        adminOrdersInfo: "Hier werden alle Bestellungen gespeichert, die per WhatsApp gesendet oder gedruckt wurden. Der Chef kann einzelne Bestellungen oder alle Eintr√§ge l√∂schen.",
        btnLogout: "Logout",
        btnClearOrders: "Alle Bestellungen l√∂schen",

        adminEditProductsTitle: "Produkte bearbeiten",
        adminProductSelectLabel: "Bestehendes Produkt w√§hlen:",
        adminProductSelectPlaceholder: "Produkt w√§hlen‚Ä¶",
        adminProductInfo: "√Ñnderungen werden lokal im Browser gespeichert (pro Ger√§t / Standort).",
        adminProdNameLabel: "Name:",
        adminProdPriceLabel: "Preis (‚Ç¨):",
        adminProdGroupLabel: "Gruppe:",
        adminProdTypeLabel: "Art:",
        adminProdCreamCheckbox: "Sahne-Option (+1,20 ‚Ç¨) erlauben",
        groupPortions: "Portionen",
        groupKids: "Kinder",
        groupEis: "Eisbecher & Spaghetti",
        groupFood: "Snacks & Waffeln",
        groupDrinks: "Getr√§nke",
        typeNormal: "Normal",
        typeCup3: "Portion (Sortenwahl)",
        btnSaveProduct: "Ausgew√§hltes Produkt speichern",
        btnDeleteProduct: "Ausgew√§hltes Produkt l√∂schen",

        adminNewProductTitle: "Neues Produkt hinzuf√ºgen",
        newProdIdLabel: "Produkt-Nr. (z.B. 701):",
        newProdNameLabel: "Name:",
        newProdPriceLabel: "Preis (‚Ç¨):",
        newProdGroupLabel: "Gruppe:",
        newProdTypeLabel: "Art:",
        newProdCreamCheckbox: "Sahne-Option (+1,20 ‚Ç¨) erlauben",
        btnCreateProduct: "Neues Produkt anlegen",

        adminFlavoursTitle: "Eissorten verwalten",
        newFlavourLabel: "Neue Sorte:",
        newFlavourPlaceholder: "z.B. Stracciatella Light",
        btnAddFlavour: "Sorte hinzuf√ºgen",

        legalSummary: "Rechtlicher Hinweis (anklicken)",
        legalHtml: `
            <p>
                Dieses Bestellsystem ist ein internes, nicht fiskalisiertes Software-Tool und ersetzt keine
                Registrierkasse oder steuerrechtlich relevante Aufzeichnung.
            </p>
            <p>
                Der Betreiber dieses Systems ist allein verantwortlich f√ºr die ordnungsgem√§√üe Nutzung und Einhaltung
                aller gesetzlichen Vorschriften. Alle √ºber dieses System erfassten Bestellungen m√ºssen ‚Äì sofern eine
                Registrierkasse oder TSE-konforme Kasse vorhanden ist ‚Äì gesetzlich korrekt in dieser registriert werden.
            </p>
            <p>
                Dieses System besitzt keine Verbindung zu einer elektronischen Kasse, erf√ºllt nicht die Anforderungen der
                Kassensicherungsverordnung (KassenSichV), der Technischen Sicherheitseinrichtung (TSE) oder der DSFinV-K
                und darf nicht als Kassensystem verwendet werden.
            </p>
            <p>
                Die Verantwortung f√ºr die steuerlich korrekte Verbuchung aller Ums√§tze liegt vollst√§ndig beim Anwender
                dieses Systems.
            </p>
        `
    },

    pt: {
        headerTitle: "Servi√ßo digital de mesa QR ‚Äì Sistema interno de pedidos",
        langLabel: "Idioma / Language / Lingua:",
        tableSectionTitle: "Escolher mesa",
        tableLabel: "Escolher n√∫mero da mesa:",
        tablePlaceholder: "Selecionar mesa‚Ä¶",
        tableInfo: "Dispon√≠vel: Mesa 1 at√© 33",

        productSectionTitle: "Escolher produto",
        tabPortions: "Por√ß√µes",
        tabKids: "Crian√ßas",
        tabEis: "Ta√ßas & Spaghetti",
        tabFood: "Snacks & Waffles",
        tabDrinks: "Bebidas",
        productLabel: "Produto:",
        productPlaceholder: "Por favor escolher‚Ä¶",

        flavourLabel: "Sabores (opcional, at√© 3):",
        flavourInfo: "Se n√£o escolher sabores, usamos a mistura padr√£o da casa.",
        creamLabel: "Natas (+1,20 ‚Ç¨):",
        creamPlaceholder: "Selecionar (opcional)",
        creamWith: "com natas (+1,20 ‚Ç¨)",
        creamWithout: "sem natas",
        creamInfo: "Se n√£o escolher nada, preparamos como est√° no menu.",
        noteLabel: "Observa√ß√£o (opcional):",
        notePlaceholder: "ex: sem natas, pouca calda‚Ä¶",
        btnAddToCart: "Adicionar ao carrinho",

        cartTitle: "üß∫ Carrinho",
        btnWhatsApp: "Enviar pedido por WhatsApp üì≤",
        btnPrint: "Imprimir pedido üñ®",
        btnResetTable: "Apagar mesa / novos clientes",
        gpsInfoChecking: "A verificar GPS‚Ä¶ por favor autorizar localiza√ß√£o.",
        gpsInfoOk: "Localiza√ß√£o OK ‚Äì pedido por WhatsApp permitido.",
        gpsInfoFar: "Est√° demasiado longe do local ‚Äì pedido por WhatsApp n√£o dispon√≠vel.",
        gpsInfoError: "N√£o foi poss√≠vel determinar a localiza√ß√£o ‚Äì por favor ativar o GPS.",

        adminSectionTitle: "√Årea do chefe",
        adminInfo: "Acesso apenas para propriet√°rio / gerente. Aqui s√£o guardados os pedidos enviados e ajustados produtos / pre√ßos.",
        adminPasswordLabel: "Palavra-passe do chefe:",
        adminPasswordPlaceholder: "Introduzir palavra-passe",
        btnAdminLogin: "Login chefe",

        adminOrdersTitle: "Pedidos guardados",
        adminOrdersInfo: "Aqui s√£o guardados todos os pedidos enviados por WhatsApp ou impressos. O chefe pode apagar pedidos individuais ou todos.",
        btnLogout: "Logout",
        btnClearOrders: "Apagar todos os pedidos",

        adminEditProductsTitle: "Editar produtos",
        adminProductSelectLabel: "Escolher produto existente:",
        adminProductSelectPlaceholder: "Escolher produto‚Ä¶",
        adminProductInfo: "As altera√ß√µes s√£o guardadas localmente no navegador (por dispositivo / local).",
        adminProdNameLabel: "Nome:",
        adminProdPriceLabel: "Pre√ßo (‚Ç¨):",
        adminProdGroupLabel: "Grupo:",
        adminProdTypeLabel: "Tipo:",
        adminProdCreamCheckbox: "Permitir op√ß√£o de natas (+1,20 ‚Ç¨)",
        groupPortions: "Por√ß√µes",
        groupKids: "Crian√ßas",
        groupEis: "Ta√ßas & Spaghetti",
        groupFood: "Snacks & Waffles",
        groupDrinks: "Bebidas",
        typeNormal: "Normal",
        typeCup3: "Por√ß√£o (escolha de sabores)",
        btnSaveProduct: "Guardar produto selecionado",
        btnDeleteProduct: "Apagar produto selecionado",

        adminNewProductTitle: "Adicionar novo produto",
        newProdIdLabel: "N¬∫ do produto (ex: 701):",
        newProdNameLabel: "Nome:",
        newProdPriceLabel: "Pre√ßo (‚Ç¨):",
        newProdGroupLabel: "Grupo:",
        newProdTypeLabel: "Tipo:",
        newProdCreamCheckbox: "Permitir op√ß√£o de natas (+1,20 ‚Ç¨)",
        btnCreateProduct: "Criar novo produto",

        adminFlavoursTitle: "Gerir sabores de gelado",
        newFlavourLabel: "Novo sabor:",
        newFlavourPlaceholder: "ex: Stracciatella Light",
        btnAddFlavour: "Adicionar sabor",

        legalSummary: "Aviso legal (clicar)",
        legalHtml: `
            <p>
                Este sistema de pedidos √© uma ferramenta interna de software, n√£o fiscalizada, e n√£o substitui uma
                caixa registadora nem um registo fiscalmente relevante.
            </p>
            <p>
                O operador deste sistema √© o √∫nico respons√°vel pela utiliza√ß√£o correta e pelo cumprimento de todas as
                obriga√ß√µes legais. Todos os pedidos registados neste sistema devem ‚Äì caso exista uma caixa registadora
                ou sistema de caixa conforme TSE ‚Äì ser registados corretamente nessa caixa.
            </p>
            <p>
                Este sistema n√£o est√° ligado a qualquer caixa eletr√≥nica, n√£o cumpre os requisitos da KassenSicherungsverordnung
                (KassenSichV), da unidade t√©cnica de seguran√ßa (TSE) ou da DSFinV-K e n√£o pode ser utilizado como sistema de caixa.
            </p>
            <p>
                A responsabilidade pela contabiliza√ß√£o fiscal correta de todas as vendas √© inteiramente do utilizador deste sistema.
            </p>
        `
    },

    it: {
        headerTitle: "Servizio digitale QR al tavolo ‚Äì Sistema interno ordini",
        langLabel: "Lingua / Language / Idioma:",
        tableSectionTitle: "Scegli il tavolo",
        tableLabel: "Seleziona il numero del tavolo:",
        tablePlaceholder: "Seleziona tavolo‚Ä¶",
        tableInfo: "Disponibile: Tavolo 1 fino a 33",

        productSectionTitle: "Scegli il prodotto",
        tabPortions: "Porzioni",
        tabKids: "Bambini",
        tabEis: "Coppe & Spaghetti",
        tabFood: "Snack & Waffle",
        tabDrinks: "Bevande",
        productLabel: "Prodotto:",
        productPlaceholder: "Seleziona‚Ä¶",

        flavourLabel: "Gusti (opzionale, fino a 3):",
        flavourInfo: "Se non vengono scelti gusti, usiamo la nostra miscela standard.",
        creamLabel: "Panna (+1,20 ‚Ç¨):",
        creamPlaceholder: "Seleziona (opzionale)",
        creamWith: "con panna (+1,20 ‚Ç¨)",
        creamWithout: "senza panna",
        creamInfo: "Se non scegli nulla, prepariamo come indicato nel men√π.",
        noteLabel: "Nota (opzionale):",
        notePlaceholder: "es: senza panna, poca salsa‚Ä¶",
        btnAddToCart: "Aggiungi al carrello",

        cartTitle: "üß∫ Carrello",
        btnWhatsApp: "Invia ordine via WhatsApp üì≤",
        btnPrint: "Stampa ordine üñ®",
        btnResetTable: "Svuota tavolo / nuovi clienti",
        gpsInfoChecking: "Verifica GPS‚Ä¶ per favore consenti la posizione.",
        gpsInfoOk: "Posizione OK ‚Äì ordine via WhatsApp possibile.",
        gpsInfoFar: "Sei troppo lontano dal locale ‚Äì ordine via WhatsApp non disponibile.",
        gpsInfoError: "Impossibile determinare la posizione ‚Äì attiva il GPS, per favore.",

        adminSectionTitle: "Area del titolare",
        adminInfo: "Accesso solo per titolare / gestore. Qui vengono salvati gli ordini inviati e modificati prodotti / prezzi.",
        adminPasswordLabel: "Password titolare:",
        adminPasswordPlaceholder: "Inserisci password",
        btnAdminLogin: "Login titolare",

        adminOrdersTitle: "Ordini salvati",
        adminOrdersInfo: "Qui vengono salvati tutti gli ordini inviati via WhatsApp o stampati. Il titolare pu√≤ cancellare singoli ordini o tutti.",
        btnLogout: "Logout",
        btnClearOrders: "Cancella tutti gli ordini",

        adminEditProductsTitle: "Modifica prodotti",
        adminProductSelectLabel: "Seleziona un prodotto esistente:",
        adminProductSelectPlaceholder: "Seleziona prodotto‚Ä¶",
        adminProductInfo: "Le modifiche vengono salvate localmente nel browser (per dispositivo / postazione).",
        adminProdNameLabel: "Nome:",
        adminProdPriceLabel: "Prezzo (‚Ç¨):",
        adminProdGroupLabel: "Gruppo:",
        adminProdTypeLabel: "Tipo:",
        adminProdCreamCheckbox: "Permetti opzione panna (+1,20 ‚Ç¨)",
        groupPortions: "Porzioni",
        groupKids: "Bambini",
        groupEis: "Coppe & Spaghetti",
        groupFood: "Snack & Waffle",
        groupDrinks: "Bevande",
        typeNormal: "Normale",
        typeCup3: "Porzione (scelta gusti)",
        btnSaveProduct: "Salva prodotto selezionato",
        btnDeleteProduct: "Elimina prodotto selezionato",

        adminNewProductTitle: "Aggiungi nuovo prodotto",
        newProdIdLabel: "Nr. prodotto (es: 701):",
        newProdNameLabel: "Nome:",
        newProdPriceLabel: "Prezzo (‚Ç¨):",
        newProdGroupLabel: "Gruppo:",
        newProdTypeLabel: "Tipo:",
        newProdCreamCheckbox: "Permetti opzione panna (+1,20 ‚Ç¨)",
        btnCreateProduct: "Crea nuovo prodotto",

        adminFlavoursTitle: "Gestisci gusti gelato",
        newFlavourLabel: "Nuovo gusto:",
        newFlavourPlaceholder: "es: Stracciatella Light",
        btnAddFlavour: "Aggiungi gusto",

        legalSummary: "Avviso legale (clicca)",
        legalHtml: `
            <p>
                Questo sistema di ordinazione √® uno strumento software interno, non fiscalizzato, e non sostituisce
                un registratore di cassa n√© una registrazione fiscalmente rilevante.
            </p>
            <p>
                Il gestore di questo sistema √® l'unico responsabile dell'uso corretto e del rispetto di tutte le norme
                di legge. Tutti gli ordini registrati tramite questo sistema devono ‚Äì se esiste un registratore di cassa
                o un sistema conforme TSE ‚Äì essere registrati correttamente in tale cassa.
            </p>
            <p>
                Questo sistema non √® collegato a nessuna cassa elettronica, non soddisfa i requisiti della
                KassenSicherungsverordnung (KassenSichV), dell'unit√† tecnica di sicurezza (TSE) o della DSFinV-K
                e non pu√≤ essere utilizzato come sistema di cassa.
            </p>
            <p>
                La responsabilit√† per la corretta contabilizzazione fiscale di tutti i corrispettivi √® completamente
                a carico dell'utilizzatore di questo sistema.
            </p>
        `
    }
};

/* Carregar configura√ß√£o local (produtos + sabores) */
(function restoreConfig() {
    try {
        const p = localStorage.getItem("sanremo_products");
        if (p) PRODUCTS = JSON.parse(p);
        const s = localStorage.getItem("sanremo_sorten");
        if (s) SORTEN = JSON.parse(s);
    } catch(e) {
        console.warn("Konfiguration konnte nicht geladen werden:", e);
    }
})();

function saveConfig() {
    try {
        localStorage.setItem("sanremo_products", JSON.stringify(PRODUCTS));
        localStorage.setItem("sanremo_sorten", JSON.stringify(SORTEN));
    } catch(e) {
        console.warn("Konfiguration konnte nicht gespeichert werden:", e);
    }
}

let warenkorb = [];
let currentGroup = "portions";

/* Tische */
const tischSelect = document.getElementById("tisch");
for (let i = 1; i <= 33; i++) {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = "Tisch " + i;
    tischSelect.appendChild(opt);
}

/* Sorten-Selects f√ºllen */
function fillSortenSelect(id) {
    const sel = document.getElementById(id);
    if (!sel) return;
    sel.innerHTML = "<option value=''>" + (currentLang === "de" ? "Sorte w√§hlen‚Ä¶" :
        currentLang === "pt" ? "Escolher sabor‚Ä¶" : "Seleziona gusto‚Ä¶") + "</option>";
    SORTEN.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        sel.appendChild(opt);
    });
}
["geschmack1", "geschmack2", "geschmack3"].forEach(fillSortenSelect);

/* Produkte nach Gruppe */
function buildProduktSelect(group) {
    const select = document.getElementById("produkt");
    select.innerHTML = "<option value=''>" + i18n[currentLang].productPlaceholder + "</option>";

    Object.keys(PRODUCTS)
        .map(id => PRODUCTS[id])
        .filter(p => p.group === group)
        .sort((a,b) => a.id - b.id)
        .forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.id;
            opt.textContent = p.id + " ‚Äì " + p.name + " ‚Äì " +
                p.preis.toFixed(2).replace(".", ",") + " ‚Ç¨";
            select.appendChild(opt);
        });

    document.getElementById("geschmack-box").style.display = "none";
    document.getElementById("sahne-box").style.display = "none";
    ["geschmack1","geschmack2","geschmack3"].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.value = "";
    });
    const sahne = document.getElementById("sahne");
    if (sahne) sahne.value = "";
    const bem = document.getElementById("bemerkung");
    if (bem) bem.value = "";
}

/* Tabs */
document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        currentGroup = btn.dataset.group;
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        buildProduktSelect(currentGroup);
    });
});
buildProduktSelect(currentGroup);

/* Produktwechsel */
document.getElementById("produkt").addEventListener("change", function() {
    const wert = this.value;
    const geschmackBox = document.getElementById("geschmack-box");
    const sahneBox = document.getElementById("sahne-box");

    if (!wert || !PRODUCTS[wert]) {
        geschmackBox.style.display = "none";
        sahneBox.style.display = "none";
        const sahne = document.getElementById("sahne");
        if (sahne) sahne.value = "";
        return;
    }

    const produkt = PRODUCTS[wert];

    if (produkt.type === "cup3") {
        geschmackBox.style.display = "block";
    } else {
        geschmackBox.style.display = "none";
        ["geschmack1", "geschmack2", "geschmack3"].forEach(id => {
            const sel = document.getElementById(id);
            if (sel) sel.value = "";
        });
    }

    if (produkt.sahne) {
        sahneBox.style.display = "block";
    } else {
        sahneBox.style.display = "none";
        const sahne = document.getElementById("sahne");
        if (sahne) sahne.value = "";
    }
});

/* Warenkorb */
function addToCart() {
    const tisch = document.getElementById("tisch").value;
    if (!tisch) {
        alert(currentLang === "de" ? "Bitte zuerst den Tisch ausw√§hlen." :
              currentLang === "pt" ? "Por favor escolha primeiro a mesa." :
              "Seleziona prima il tavolo, per favore.");
        return;
    }

    const produktId = document.getElementById("produkt").value;
    if (!produktId || !PRODUCTS[produktId]) {
        alert(currentLang === "de" ? "Bitte ein Produkt ausw√§hlen." :
              currentLang === "pt" ? "Por favor escolhe um produto." :
              "Seleziona un prodotto, per favore.");
        return;
    }

    const produkt = PRODUCTS[produktId];
    let sorten = [];
    const bemerkung = document.getElementById("bemerkung").value.trim();

    if (produkt.type === "cup3") {
        const s1 = document.getElementById("geschmack1").value;
        const s2 = document.getElementById("geschmack2").value;
        const s3 = document.getElementById("geschmack3").value;
        if (s1) sorten.push(s1);
        if (s2) sorten.push(s2);
        if (s3) sorten.push(s3);
    }

    let sahne = "";
    let sahneZuschlag = 0;
    if (produkt.sahne) {
        sahne = document.getElementById("sahne").value;
        if (sahne === "mit Sahne" || sahne === "com natas" || sahne === "con panna") {
            sahneZuschlag = SAHNE_AUFSCHLAG;
        }
    }

    const endPreis = produkt.preis + sahneZuschlag;

    warenkorb.push({
        id: produkt.id,
        name: produkt.name,
        preis: endPreis,
        grundpreis: produkt.preis,
        type: produkt.type,
        sorten: sorten,
        bemerkung: bemerkung,
        sahne: sahne,
        sahneZuschlag: sahneZuschlag
    });

    document.getElementById("bemerkung").value = "";
    if (produkt.type === "cup3") {
        ["geschmack1", "geschmack2", "geschmack3"].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = "";
        });
    }
    document.getElementById("produkt").value = "";

    const sah = document.getElementById("sahne");
    if (sah) sah.value = "";

    updateCart();
}

function updateCart() {
    const liste = document.getElementById("liste-items");
    const totalDiv = document.getElementById("gesamt");
    const btnWpp = document.getElementById("btn-whatsapp");
    const btnPrint = document.getElementById("btn-print");

    liste.innerHTML = "";
    let total = 0;

    warenkorb.forEach((item, index) => {
        total += item.preis;

        const line = document.createElement("div");
        line.className = "line-item";

        const info = document.createElement("div");
        info.className = "item-info";

        let text = item.name + " ‚Äì " + item.preis.toFixed(2).replace(".", ",") + " ‚Ç¨";
        if (item.type === "cup3" && item.sorten.length > 0) {
            text += "<br><span class='small'>Sorten: " + item.sorten.join(", ") + "</span>";
        }
        if (item.bemerkung) {
            text += "<br><span class='small'>" +
                (currentLang === "de" ? "Bemerkung: " :
                 currentLang === "pt" ? "Observa√ß√£o: " : "Nota: ") +
                item.bemerkung + "</span>";
        }
        if (item.sahne) {
            text += "<br><span class='small'>Sahne: " + item.sahne + "</span>";
        }
        info.innerHTML = text;

        const btnRemove = document.createElement("button");
        btnRemove.className = "btn-remove";
        btnRemove.textContent = "X";
        btnRemove.onclick = () => removeItem(index);

        line.appendChild(info);
        line.appendChild(btnRemove);
        liste.appendChild(line);
    });

    const totalLabel =
        currentLang === "de" ? "Gesamt" :
        currentLang === "pt" ? "Total" : "Totale";

    totalDiv.textContent = totalLabel + ": " +
        total.toFixed(2).replace(".", ",") + " ‚Ç¨";

    const hasItems = warenkorb.length > 0;
    if (btnWpp) btnWpp.disabled = !hasItems || !gpsOk;
    if (btnPrint) btnPrint.disabled = !hasItems;
}

function removeItem(index) {
    warenkorb.splice(index, 1);
    updateCart();
}

/* Bestellungstext */
function buildOrderText() {
    const tisch = document.getElementById("tisch").value || "-";
    let total = 0;

    let header;
    let totalLabel;
    if (currentLang === "de") {
        header = "Tisch " + tisch + " - Bestellung:";
        totalLabel = "Gesamtbetrag";
    } else if (currentLang === "pt") {
        header = "Mesa " + tisch + " - Pedido:";
        totalLabel = "Total";
    } else {
        header = "Tavolo " + tisch + " - Ordine:";
        totalLabel = "Totale";
    }

    let text = header + "\n";

    warenkorb.forEach(item => {
        total += item.preis;
        let line = "‚Ä¢ " + item.name + " (" + item.preis.toFixed(2) + " ‚Ç¨)";
        if (item.type === "cup3" && item.sorten.length > 0) {
            const label =
                currentLang === "de" ? "Sorten" :
                currentLang === "pt" ? "Sabores" : "Gusti";
            line += " ‚Äì " + label + ": " + item.sorten.join(", ");
        }
        if (item.bemerkung) {
            const label =
                currentLang === "de" ? "Bemerkung" :
                currentLang === "pt" ? "Obs." : "Nota";
            line += " ‚Äì " + label + ": " + item.bemerkung;
        }
        if (item.sahne) {
            line += " ‚Äì Sahne: " + item.sahne;
        }
        text += line + "\n";
    });

    text += "\n" + totalLabel + ": " + total.toFixed(2) + " ‚Ç¨";
    return text;
}

/* Bestellungen f√ºr Chef speichern (apenas em mem√≥ria por enquanto) */
function storeOrder(channel) {
    const tisch = document.getElementById("tisch").value || "-";
    const textPlain = buildOrderText();
    const timestamp = new Date().toLocaleString("de-DE");
    adminOrders.push({ tisch, channel, text: textPlain, time: timestamp });
    if (isAdmin) updateAdminList();
}

/* WhatsApp */
function sendWhatsApp() {
    if (!gpsOk) {
        alert(
            currentLang === "de"
                ? "Bestellung nur vor Ort m√∂glich. Bitte Standort-Freigabe erlauben."
                : currentLang === "pt"
                ? "Pedido s√≥ poss√≠vel no local. Por favor autorize a localiza√ß√£o."
                : "Ordine possibile solo in loco. Consenti la posizione, per favore."
        );
        return;
    }

    const tisch = document.getElementById("tisch").value;
    if (!tisch) {
        alert(
            currentLang === "de"
                ? "Bitte zuerst den Tisch ausw√§hlen."
                : currentLang === "pt"
                ? "Por favor escolha primeiro a mesa."
                : "Seleziona prima il tavolo, per favore."
        );
        return;
    }
    if (warenkorb.length === 0) {
        alert(
            currentLang === "de"
                ? "Der Warenkorb ist leer."
                : currentLang === "pt"
                ? "O carrinho est√° vazio."
                : "Il carrello √® vuoto."
        );
        return;
    }

    storeOrder("WhatsApp");
    const text = encodeURIComponent(buildOrderText());
    const url = https://wa.me/${WHATSAPP_NUMMER}?text=${text};
    window.open(url, "_blank");

    warenkorb = [];
    updateCart();
}

/* Drucker ‚Äì s√≥ dispon√≠vel para o CHEFE (btn aparece no adminLogin) */
function printOrder() {
    if (warenkorb.length === 0) {
        alert(
            currentLang === "de"
                ? "Der Warenkorb ist leer."
                : currentLang === "pt"
                ? "O carrinho est√° vazio."
                : "Il carrello √® vuoto."
        );
        return;
    }
    const tisch = document.getElementById("tisch").value || "-";
    const textHtml = buildOrderText().replace(/\n/g, "<br>");

    storeOrder("Drucker");

    const win = window.open("", "_blank");
    win.document.open();
    win.document.write(`
        <html>
        <head>
            <title>Bestellung Tisch ${tisch}</title>
            <meta charset="UTF-8">
        </head>
        <body style="font-family:Arial,sans-serif; font-size:14px;">
            <h2>Bestellung Tisch ${tisch}</h2>
            <p>${textHtml}</p>
        </body>
        </html>
    `);
    win.document.close();
    win.print();
}

/* Reset */
function resetTable() {
    if (!confirm(
        currentLang === "de"
            ? "M√∂chten Sie den Tisch wirklich zur√ºcksetzen? Alle Bestellungen werden gel√∂scht."
            : currentLang === "pt"
            ? "Quer mesmo apagar a mesa? Todos os pedidos ser√£o apagados."
            : "Vuoi davvero svuotare il tavolo? Tutti gli ordini saranno cancellati."
    )) {
        return;
    }

    warenkorb = [];
    updateCart();

    const tischSel = document.getElementById("tisch");
    if (tischSel) tischSel.value = "";

    const produktSel = document.getElementById("produkt");
    if (produktSel) produktSel.value = "";

    ["geschmack1", "geschmack2", "geschmack3"].forEach(id => {
        const sel = document.getElementById(id);
        if (sel) sel.value = "";
    });

    const sahneSel = document.getElementById("sahne");
    if (sahneSel) sahneSel.value = "";

    document.getElementById("bemerkung").value = "";
}

/* GPS */
function deg2rad(deg) { return deg * (Math.PI / 180); }

function distanceKm(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = deg2rad(lat2 - lat1);
    const dLon = deg2rad(lon2 - lon1);
    const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}

function initLocation() {
    const info = document.getElementById("gps-info");
    const btnWpp = document.getElementById("btn-whatsapp");

    if (!navigator.geolocation) {
        info.textContent = i18n[currentLang].gpsInfoError;
        gpsOk = false;
        btnWpp.disabled = true;
        return;
    }

    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const dist = distanceKm(lat, lng, CAFE_LAT, CAFE_LNG);

            if (dist <= MAX_DIST_KM) {
                gpsOk = true;
                info.textContent = i18n[currentLang].gpsInfoOk;
            } else {
                gpsOk = false;
                info.textContent = i18n[currentLang].gpsInfoFar;
            }
            updateCart();
        },
        (err) => {
            gpsOk = false;
            info.textContent = i18n[currentLang].gpsInfoError;
            btnWpp.disabled = true;
        }
    );
}

/* Chef-Login & Admin-Panel */
function adminLogin() {
    const pw = document.getElementById("admin-password").value;
    if (pw === ADMIN_PASSWORD) {
        isAdmin = true;
        document.getElementById("admin-login-card").style.display = "none";
        document.getElementById("admin-panel").style.display = "block";
        const btnPrint = document.getElementById("btn-print");
        if (btnPrint) btnPrint.style.display = "block"; // Drucker s√≥ vis√≠vel na cozinha (chefe)
        updateAdminList();
        populateAdminProducts();
        renderSortenList();
    } else {
        alert(
            currentLang === "de"
                ? "Falsches Passwort."
                : currentLang === "pt"
                ? "Palavra-passe incorreta."
                : "Password errata."
        );
    }
}

function adminLogout() {
    isAdmin = false;
    document.getElementById("admin-panel").style.display = "none";
    document.getElementById("admin-login-card").style.display = "block";
    document.getElementById("admin-password").value = "";
    const btnPrint = document.getElementById("btn-print");
    if (btnPrint) btnPrint.style.display = "none";
}

/* Admin: Bestell-Liste */
function updateAdminList() {
    const list = document.getElementById("admin-orders-list");
    list.innerHTML = "";
    if (adminOrders.length === 0) {
        const msg =
            currentLang === "de" ? "Noch keine Bestellungen gespeichert." :
            currentLang === "pt" ? "Ainda n√£o h√° pedidos guardados." :
            "Nessun ordine salvato.";
        list.innerHTML = "<div class='small'>" + msg + "</div>";
        return;
    }

    adminOrders.forEach((o, idx) => {
        const div = document.createElement("div");
        div.className = "admin-order";
        div.innerHTML = `
            <strong>${o.time}</strong> ‚Äì Tisch ${o.tisch} (${o.channel})<br>
            ${o.text.replace(/\n/g,"<br>")}
            <br>
            <button class="btn-small" onclick="deleteOrder(${idx})">L√∂schen</button>
        `;
        list.appendChild(div);
    });
}

function deleteOrder(index) {
    adminOrders.splice(index, 1);
    updateAdminList();
}

function clearAllOrders() {
    if (!confirm(
        currentLang === "de"
            ? "Alle gespeicherten Bestellungen wirklich l√∂schen?"
            : currentLang === "pt"
            ? "Apagar mesmo todos os pedidos guardados?"
            : "Vuoi davvero cancellare tutti gli ordini salvati?"
    )) return;
    adminOrders = [];
    updateAdminList();
}

/* Admin: Produkte verwalten */
function populateAdminProducts() {
    const sel = document.getElementById("admin-product-select");
    sel.innerHTML = "<option value=''>" + i18n[currentLang].adminProductSelectPlaceholder + "</option>";
    Object.keys(PRODUCTS)
        .map(id => PRODUCTS[id])
        .sort((a,b) => a.id - b.id)
        .forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.id;
            opt.textContent = p.id + " ‚Äì " + p.name + " (" + p.group + ")";
            sel.appendChild(opt);
        });

    sel.onchange = () => {
        const id = sel.value;
        if (!id || !PRODUCTS[id]) return;
        const p = PRODUCTS[id];
        document.getElementById("admin-prod-name").value = p.name;
        document.getElementById("admin-prod-price").value =
            p.preis.toString().replace(".", ",").replace(",",".");
        document.getElementById("admin-prod-group").value = p.group;
        document.getElementById("admin-prod-type").value = p.type;
        document.getElementById("admin-prod-sahne").checked = !!p.sahne;
    };
}

function saveExistingProduct() {
    const sel = document.getElementById("admin-product-select");
    const id = sel.value;
    if (!id || !PRODUCTS[id]) {
        alert(
            currentLang === "de"
                ? "Bitte zuerst ein Produkt w√§hlen."
                : currentLang === "pt"
                ? "Por favor escolha primeiro um produto."
                : "Seleziona prima un prodotto, per favore."
        );
        return;
    }
    const name = document.getElementById("admin-prod-name").value.trim();
    let preis = parseFloat(document.getElementById("admin-prod-price").value.replace(",","."));
    const group = document.getElementById("admin-prod-group").value;
    const type = document.getElementById("admin-prod-type").value;
    const sahne = document.getElementById("admin-prod-sahne").checked;

    if (!name || isNaN(preis)) {
        alert(
            currentLang === "de"
                ? "Name und Preis sind erforderlich."
                : currentLang === "pt"
                ? "Nome e pre√ßo s√£o obrigat√≥rios."
                : "Nome e prezzo sono obbligatori."
        );
        return;
    }

    PRODUCTS[id].name = name;
    PRODUCTS[id].preis = preis;
    PRODUCTS[id].group = group;
    PRODUCTS[id].type = type;
    PRODUCTS[id].sahne = sahne;

    saveConfig();
    populateAdminProducts();
    buildProduktSelect(currentGroup);
    alert(
        currentLang === "de"
            ? "Produkt gespeichert."
            : currentLang === "pt"
            ? "Produto guardado."
            : "Prodotto salvato."
    );
}

function deleteExistingProduct() {
    const sel = document.getElementById("admin-product-select");
    const id = sel.value;
    if (!id || !PRODUCTS[id]) {
        alert(
            currentLang === "de"
                ? "Bitte zuerst ein Produkt w√§hlen."
                : currentLang === "pt"
                ? "Por favor escolha primeiro um produto."
                : "Seleziona prima un prodotto, per favore."
        );
        return;
    }
    if (!confirm(
        currentLang === "de"
            ? "Produkt wirklich l√∂schen?"
            : currentLang === "pt"
            ? "Apagar mesmo este produto?"
            : "Vuoi davvero eliminare questo prodotto?"
    )) return;
    delete PRODUCTS[id];
    saveConfig();
    populateAdminProducts();
    buildProduktSelect(currentGroup);
    alert(
        currentLang === "de"
            ? "Produkt gel√∂scht."
            : currentLang === "pt"
            ? "Produto apagado."
            : "Prodotto eliminato."
    );
}

function addNewProduct() {
    const idVal = document.getElementById("new-prod-id").value;
    const name = document.getElementById("new-prod-name").value.trim();
    let preis = parseFloat(document.getElementById("new-prod-price").value.replace(",","."));
    const group = document.getElementById("new-prod-group").value;
    const type = document.getElementById("new-prod-type").value;
    const sahne = document.getElementById("new-prod-sahne").checked;

    const id = parseInt(idVal, 10);
    if (!idVal || isNaN(id) || !name || isNaN(preis)) {
        alert(
            currentLang === "de"
                ? "Bitte Produktnummer, Name und Preis eingeben."
                : currentLang === "pt"
                ? "Por favor introduza n¬∫ do produto, nome e pre√ßo."
                : "Inserisci numero prodotto, nome e prezzo, per favore."
        );
        return;
    }
    if (PRODUCTS[id]) {
        if (!confirm(
            currentLang === "de"
                ? "Diese Produktnummer existiert bereits. √úberschreiben?"
                : currentLang === "pt"
                ? "Este n√∫mero de produto j√° existe. Substituir?"
                : "Questo numero prodotto esiste gi√†. Sovrascrivere?"
        )) return;
    }

    PRODUCTS[id] = { id, name, preis, type, group, sahne };

    document.getElementById("new-prod-id").value = "";
    document.getElementById("new-prod-name").value = "";
    document.getElementById("new-prod-price").value = "";
    document.getElementById("new-prod-group").value = "portions";
    document.getElementById("new-prod-type").value = "normal";
    document.getElementById("new-prod-sahne").checked = false;

    saveConfig();
    populateAdminProducts();
    buildProduktSelect(currentGroup);
    alert(
        currentLang === "de"
            ? "Neues Produkt angelegt."
            : currentLang === "pt"
            ? "Novo produto criado."
            : "Nuovo prodotto creato."
    );
}

/* Admin: Sorten verwalten */
function renderSortenList() {
    const cont = document.getElementById("sorten-list");
    if (!cont) return;
    if (SORTEN.length === 0) {
        const msg =
            currentLang === "de" ? "Keine Sorten definiert." :
            currentLang === "pt" ? "Nenhum sabor definido." :
            "Nessun gusto definito.";
        cont.textContent = msg;
        return;
    }
    let html = "";
    SORTEN.forEach((s, idx) => {
        html += `<span style="display:inline-block;margin:2px 4px;padding:2px 6px;border-radius:999px;background:#f1f1f1;">
            ${s}
            <button style="border:none;background:transparent;font-size:11px;cursor:pointer;"
                    onclick="deleteSorte(${idx})">x</button>
        </span>`;
    });
    cont.innerHTML = html;
}

function deleteSorte(idx) {
    SORTEN.splice(idx, 1);
    saveConfig();
    renderSortenList();
    ["geschmack1", "geschmack2", "geschmack3"].forEach(fillSortenSelect);
}

function addNewSorte() {
    const input = document.getElementById("new-sorte");
    const name = input.value.trim();
    if (!name) {
        alert(
            currentLang === "de"
                ? "Bitte einen Sortennamen eingeben."
                : currentLang === "pt"
                ? "Por favor introduza o nome do sabor."
                : "Inserisci il nome del gusto, per favore."
        );
        return;
    }
    SORTEN.push(name);
    input.value = "";
    saveConfig();
    renderSortenList();
    ["geschmack1", "geschmack2", "geschmack3"].forEach(fillSortenSelect);
}

/* Tradu√ß√µes ‚Äì aplica textos conforme currentLang */
function applyTranslations() {
    const t = i18n[currentLang];

    document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        if (t[key]) el.textContent = t[key];
    });

    document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
        const key = el.getAttribute("data-i18n-placeholder");
        if (t[key]) el.placeholder = t[key];
    });

    const legal = document.getElementById("legal-text");
    if (legal) legal.innerHTML = t.legalHtml;

    fillSortenSelect("geschmack1");
    fillSortenSelect("geschmack2");
    fillSortenSelect("geschmack3");
    buildProduktSelect(currentGroup);
    updateAdminList();
    populateAdminProducts();

    const gpsInfo = document.getElementById("gps-info");
    if (!gpsOk && gpsInfo) gpsInfo.textContent = t.gpsInfoChecking;
}

/* Listener para mudar l√≠ngua */
document.getElementById("lang-select").addEventListener("change", function() {
    currentLang = this.value || "de";
    applyTranslations();
});

/* Init */
window.addEventListener("load", function() {
    applyTranslations();
    initLocation();
});
</script>

</body>
</html>
