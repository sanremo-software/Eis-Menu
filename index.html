<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Food & Drinks ‚Äì QR Tischbestellung</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --primary: #e53935;
            --primary-dark: #b71c1c;
            --bg: #fff8f2;
            --card-bg: #ffffff;

            --tab-portions: #ffb300;
            --tab-kids: #ff4081;
            --tab-eis: #29b6f6;
            --tab-food: #66bb6a;
            --tab-drinks: #ab47bc;
        }
        * { box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: radial-gradient(circle at top, #fffdf8 0%, #fff3e0 35%, #ffe0b2 100%);
            margin: 0;
            padding: 0;
            color: #222;
        }

        /* HEADER */
        .header {
            width: 100%;
            background: linear-gradient(135deg, #ffffff 0%, #fff8e1 40%, #ffe0b2 100%);
            padding: 12px 0 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.06);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .header-inner {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 0 10px;
        }
        .header-logo {
            max-width: 100%;
            max-height: 80px;
            height: auto;
            width: auto;
            object-fit: contain;
        }
        .header-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            letter-spacing: 0.5px;
            text-align: center;
        }
        @media (max-width: 600px) {
            .header-inner {
                flex-direction: column;
                gap: 6px;
            }
            .header-title {
                font-size: 17px;
            }
        }

        .container {
            padding: 15px;
            max-width: 960px;
            margin: 0 auto 25px auto;
        }
        .section-title {
            font-size: 18px;
            margin-top: 18px;
            margin-bottom: 8px;
            border-left: 4px solid var(--primary);
            padding-left: 8px;
        }
        .card {
            background: var(--card-bg);
            padding: 14px;
            border-radius: 14px;
            margin-bottom: 14px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.06);
            border: 1px solid rgba(255,255,255,0.8);
        }
        label {
            font-size: 14px;
            display: block;
            margin-top: 5px;
            margin-bottom: 3px;
        }
        select, input {
            width: 100%;
            padding: 9px 10px;
            font-size: 14px;
            border-radius: 10px;
            border: 1px solid #d0d0d0;
            background: #fff;
        }
        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(229,57,53,0.2);
        }
        .btn {
            background: var(--primary);
            color: #fff;
            padding: 10px;
            display: inline-block;
            text-align: center;
            border-radius: 999px;
            text-decoration: none;
            margin-top: 12px;
            font-size: 16px;
            border: none;
            cursor: pointer;
            width: 100%;
            transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.1s ease;
        }
        .btn:hover {
            background: var(--primary-dark);
            box-shadow: 0 4px 10px rgba(0,0,0,0.18);
            transform: translateY(-1px);
        }
        .btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
        }
        .btn:disabled {
            background: #c5c5c5;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        #warenkorb {
            background: rgba(255,255,255,0.98);
            padding: 14px;
            border-radius: 16px;
            margin-top: 20px;
            box-shadow: 0 8px 18px rgba(0,0,0,0.08);
            border: 1px solid rgba(255,255,255,0.9);
        }
        #liste-items div {
            padding: 6px 0;
            border-bottom: 1px dashed #e0e0e0;
            font-size: 14px;
        }
        .line-item {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: center;
        }
        .item-info {
            flex: 1;
        }
        .btn-remove {
            background: #ff7043;
            border: none;
            color: #fff;
            padding: 4px 9px;
            border-radius: 999px;
            font-size: 11px;
            cursor: pointer;
        }
        .btn-remove:hover {
            background: #f4511e;
        }
        .total {
            font-weight: bold;
            font-size: 16px;
            margin-top: 10px;
            text-align: right;
        }
        .small {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }

        /* TABS / JANELAS */
        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
        }
        .tab-btn {
            flex: 1 1 auto;
            padding: 7px 8px;
            font-size: 13px;
            border-radius: 999px;
            border: 1px solid #ddd;
            background: #ffffff;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #444;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .tab-btn.active {
            color: #fff;
            border-color: transparent;
            box-shadow: 0 3px 9px rgba(0,0,0,0.15);
        }
        .tab-portions.active { background: var(--tab-portions); }
        .tab-kids.active     { background: var(--tab-kids); }
        .tab-eis.active      { background: var(--tab-eis); }
        .tab-food.active     { background: var(--tab-food); }
        .tab-drinks.active   { background: var(--tab-drinks); }

        .tab-portions { border-color: rgba(255,179,0,0.6); }
        .tab-kids     { border-color: rgba(255,64,129,0.5); }
        .tab-eis      { border-color: rgba(41,182,246,0.5); }
        .tab-food     { border-color: rgba(102,187,106,0.6); }
        .tab-drinks   { border-color: rgba(171,71,188,0.6); }

        @media (max-width: 600px) {
            .tab-btn {
                font-size: 11px;
                padding: 6px 6px;
            }
        }

        /* Chef-Bereich */
        .admin-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        .btn-logout {
            background: #757575;
            border: none;
            color: #fff;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
        }
        .btn-logout:hover {
            background: #616161;
        }
        .admin-order {
            border-bottom: 1px dashed #ddd;
            padding: 6px 0;
            font-size: 12px;
        }
        .btn-small {
            background: #c62828;
            border: none;
            color: #fff;
            padding: 3px 7px;
            border-radius: 999px;
            font-size: 11px;
            cursor: pointer;
            margin-top: 3px;
        }
        .btn-small:hover {
            background: #b71c1c;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-top: 8px;
        }
        .admin-table th,
        .admin-table td {
            border-bottom: 1px solid #eee;
            padding: 4px 3px;
            vertical-align: middle;
        }
        .admin-table input[type="text"],
        .admin-table input[type="number"],
        .admin-table select {
            width: 100%;
            font-size: 11px;
            padding: 3px 5px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }
        .admin-table input[type="checkbox"] {
            transform: scale(1.1);
        }

        .admin-subtitle {
            font-size: 13px;
            margin-top: 10px;
            margin-bottom: 4px;
            font-weight: bold;
        }

        /* Rechtlicher Hinweis ‚Äì s√≥ no Chef-Panel */
        .legal-box {
            font-size: 11px;
            color: #777;
            margin-top: 12px;
            text-align: left;
            line-height: 1.5;
        }
        .legal-box details {
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            padding: 8px 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .legal-box summary {
            cursor: pointer;
        }
    </style>
</head>

<body>

<header class="header">
    <div class="header-inner">
        <!-- certifica-te que o ficheiro existe na pasta: food-drinks-logo.png -->
        <img src="food-drinks-logo.png" alt="Food & Drinks Logo" class="header-logo">
        <div class="header-title">Digitaler QR-Tischservice ‚Äì Internes Bestellsystem</div>
    </div>
</header>

<div class="container">

    <!-- TISCHWAHL -->
    <div class="card">
        <h2 class="section-title">Tisch w√§hlen</h2>
        <label for="tisch">Tischnummer ausw√§hlen:</label>
        <select id="tisch">
            <option value="">Tisch ausw√§hlen‚Ä¶</option>
        </select>
        <div class="small">Verf√ºgbar: Tisch 1 bis 33</div>
    </div>

    <!-- PRODUKTWAHL -->
    <div class="card">
        <h2 class="section-title">Produkt w√§hlen</h2>

        <!-- 5 JANELAS -->
        <div class="tabs">
            <button class="tab-btn tab-portions active" data-group="portions">Portionen</button>
            <button class="tab-btn tab-kids" data-group="kids">Kinder</button>
            <button class="tab-btn tab-eis" data-group="eis">Eisbecher & Spaghetti</button>
            <button class="tab-btn tab-food" data-group="food">Snacks & Waffeln</button>
            <button class="tab-btn tab-drinks" data-group="drinks">Getr√§nke</button>
        </div>

        <label for="produkt">Produkt:</label>
        <select id="produkt"></select>

        <!-- Sortenwahl nur f√ºr Portionen (optional) -->
        <div id="geschmack-box" style="margin-top:12px; display:none;">
            <label>Sorten (optional, bis zu 3 w√§hlen):</label>
            <select id="geschmack1"></select>
            <select id="geschmack2" style="margin-top:6px;"></select>
            <select id="geschmack3" style="margin-top:6px;"></select>
            <div class="small">
                Wenn keine Sorten gew√§hlt werden, kommt die Portion in unserer Standardmischung.
            </div>
        </div>

        <!-- Sahne-Option -->
        <div id="sahne-box" style="margin-top:8px; display:none;">
            <label for="sahne">Sahne:</label>
            <select id="sahne">
                <option value="">Bitte ausw√§hlen (optional)</option>
                <option value="mit Sahne">mit Sahne</option>
                <option value="ohne Sahne">ohne Sahne</option>
            </select>
            <div class="small">
                Wenn nichts gew√§hlt wird, bereiten wir es wie auf der Karte zu.
            </div>
        </div>

        <label for="bemerkung" style="margin-top:8px;">Bemerkung (optional):</label>
        <input id="bemerkung" type="text" placeholder="z.B. ohne Sahne, wenig So√üe ‚Ä¶">

        <button class="btn" onclick="addToCart()">Zum Warenkorb hinzuf√ºgen</button>
    </div>

    <!-- WARENKORB -->
    <div id="warenkorb">
        <h2 class="section-title">üß∫ Warenkorb</h2>
        <div id="liste-items"></div>
        <div class="total" id="gesamt">Gesamt: 0,00 ‚Ç¨</div>

        <button id="btn-whatsapp" class="btn" onclick="sendWhatsApp()" disabled>
            Bestellung per WhatsApp senden üì≤
        </button>

        <button id="btn-print" class="btn" style="margin-top:8px; background:#007b83;" onclick="printOrder()" disabled>
            Bestellung drucken üñ®Ô∏è
        </button>

        <button class="btn" style="margin-top:8px; background:#555;" onclick="resetTable()">
            Tisch l√∂schen / neue G√§ste
        </button>

        <div class="small" style="margin-top:6px;" id="gps-info">
            GPS wird gepr√ºft‚Ä¶ bitte Standort-Freigabe erlauben.
        </div>
    </div>

    <!-- CHEF LOGIN -->
    <div class="card" id="admin-login-card">
        <h2 class="section-title">Chef-Bereich</h2>
        <p class="small">
            Zugang nur f√ºr Inhaber / Gesch√§ftsf√ºhrer. Hier werden alle gesendeten Bestellungen gespeichert
            und das Men√º (Produkte & Preise) verwaltet.
        </p>
        <label for="admin-password">Chef-Passwort:</label>
        <input id="admin-password" type="password" placeholder="Passwort eingeben">
        <button class="btn" onclick="adminLogin()">Chef-Login</button>
        <div class="small" style="margin-top:4px;">
            (Standard-Passwort: 1234 ‚Äì bitte im Code anpassen)
        </div>
    </div>

    <!-- CHEF PANEL -->
    <div class="card" id="admin-panel" style="display:none;">
        <div class="admin-header">
            <h2 class="section-title" style="margin-bottom:0;">Chef-Bereich</h2>
            <button class="btn-logout" onclick="adminLogout()">Logout</button>
        </div>

        <!-- BESTELLUNGEN -->
        <div class="admin-subtitle">Gespeicherte Bestellungen</div>
        <div class="small" style="margin-top:2px;">
            Hier werden alle Bestellungen gespeichert, die per WhatsApp gesendet oder gedruckt wurden.
            Der Chef kann einzelne Bestellungen oder alle Eintr√§ge l√∂schen.
        </div>
        <div id="admin-orders-list" style="margin-top:10px;"></div>
        <button class="btn" style="margin-top:10px; background:#c62828;" onclick="clearAllOrders()">
            Alle Bestellungen l√∂schen
        </button>

        <!-- PRODUKT & PREIS VERWALTUNG -->
        <div class="admin-subtitle" style="margin-top:16px;">Produkte & Preise verwalten</div>
        <div class="small">
            W√§hle eine Kategorie, passe Namen, Preise und Optionen an oder f√ºge neue Produkte hinzu.
            √Ñnderungen werden nur auf diesem Ger√§t gespeichert (lokal).
        </div>

        <label for="admin-group-select" style="margin-top:6px;">Kategorie:</label>
        <select id="admin-group-select"></select>

        <div id="admin-products-editor"></div>

        <button class="btn" style="margin-top:10px; background:#00897b;" onclick="adminAddProduct()">
            Neues Produkt in dieser Kategorie hinzuf√ºgen
        </button>

        <button class="btn" style="margin-top:8px;" onclick="adminSaveProducts()">
            √Ñnderungen speichern
        </button>

        <!-- Rechtlicher Hinweis nur f√ºr Chef -->
        <div class="legal-box">
            <details>
                <summary><strong>Rechtlicher Hinweis (anklicken)</strong></summary>
                <p>
                    Dieses Bestellsystem ist ein internes, nicht fiskalisiertes Software-Tool und ersetzt keine
                    Registrierkasse oder steuerrechtlich relevante Aufzeichnung.
                </p>
                <p>
                    Der Betreiber dieses Systems ist allein verantwortlich f√ºr die ordnungsgem√§√üe Nutzung und Einhaltung
                    aller gesetzlichen Vorschriften. Alle √ºber dieses System erfassten Bestellungen m√ºssen ‚Äì sofern eine
                    Registrierkasse oder TSE-konforme Kasse vorhanden ist ‚Äì gesetzlich korrekt in dieser registriert werden.
                </p>
                <p>
                    Dieses System besitzt keine Verbindung zu einer elektronischen Kasse, erf√ºllt nicht die Anforderungen der
                    Kassensicherungsverordnung (KassenSichV), der Technischen Sicherheitseinrichtung (TSE) oder der DSFinV-K
                    und darf nicht als Kassensystem verwendet werden.
                </p>
                <p>
                    Die Verantwortung f√ºr die steuerlich korrekte Verbuchung aller Ums√§tze liegt vollst√§ndig beim Anwender
                    dieses Systems.
                </p>
            </details>
        </div>
    </div>

</div>

<script>
/* =================== CONFIG GERAL =================== */

const WHATSAPP_NUMMER = "4917672809926";
/* Standard Chef-Passwort ‚Äì PODES MUDAR AQUI */
const ADMIN_PASSWORD = "1234";

/* Coordenadas do caf√© (ajusta por cliente) */
const CAFE_LAT = 51.051;   // latitude aproximada
const CAFE_LNG = 8.392;    // longitude aproximada
const MAX_DIST_KM = 1.5;   // raio permitido para pedidos via WhatsApp

let gpsOk = false;
let isAdmin = false;
let currentGroup = "portions";

let menuData = null;       // { products, groups, nextId }
let adminOrders = [];      // hist√≥rico de pedidos (guardado em localStorage)
let warenkorb = [];

/* =================== DADOS DEFAULT ‚Äì MENU =================== */

/* Produtos base (podes ajustar aqui o ‚Äúmenu padr√£o‚Äù) */
const DEFAULT_PRODUCTS = {
    23: { name: "23. Kinder Portion (2 Kugeln)", preis: 3.50, type: "cup3" },
    24: { name: "24. Kleine Portion (3 Kugeln)", preis: 5.00, type: "cup3" },
    25: { name: "25. Normale Portion (4 Kugeln)", preis: 6.50, type: "cup3" },
    26: { name: "26. Gro√üe Portion (6 Kugeln)", preis: 9.50, type: "cup3" },

    30: { name: "30. Amarena Becher", preis: 8.50, type: "normal" },
    31: { name: "31. Erdbeer Becher", preis: 8.50, type: "normal" },
    32: { name: "32. Banana Cup", preis: 9.00, type: "normal" },
    33: { name: "33. Liebes Traum", preis: 13.50, type: "normal" },
    34: { name: "34. Kiwi Becher", preis: 8.50, type: "normal" },
    35: { name: "35. Frucht Becher", preis: 8.50, type: "normal" },
    36: { name: "36. Gro√üer Frucht Becher", preis: 11.90, type: "normal" },
    37: { name: "37. Gro√üer Amarena Becher", preis: 12.50, type: "normal" },
    38: { name: "38. Gro√üer Erdbeer Becher", preis: 12.50, type: "normal" },
    39: { name: "39. Erdbeer-Banane Becher", preis: 10.90, type: "normal" },
    40: { name: "40. Exotischer Becher", preis: 12.00, type: "normal" },
    41: { name: "41. Wald Becher", preis: 10.50, type: "normal" },
    42: { name: "42. Bella Italia", preis: 11.00, type: "normal" },
    43: { name: "43. Mango Becher", preis: 9.00, type: "normal" },
    44: { name: "44. Banana Split", preis: 10.00, type: "normal" },
    45: { name: "45. Sommer Becher", preis: 13.00, type: "normal" },
    46: { name: "46. Coppa Melone", preis: 9.50, type: "normal" },
    47: { name: "47. Heidelbeer Becher", preis: 9.50, type: "normal" },
    48: { name: "48. Himbeer Becher", preis: 9.50, type: "normal" },

    50: { name: "50. Spaghetti Eis", preis: 6.50, type: "normal" },
    51: { name: "51. Spaghetti Eis gro√ü", preis: 9.50, type: "normal" },
    52: { name: "52. Spaghetti Vanille", preis: 7.40, type: "normal" },
    53: { name: "53. Spaghetti Erdbeere", preis: 8.90, type: "normal" },
    54: { name: "54. Spaghetti Kiwi", preis: 8.50, type: "normal" },
    55: { name: "55. Spaghetti Vanille-Schoko", preis: 7.50, type: "normal" },
    56: { name: "56. Spaghetti Carbonara", preis: 9.50, type: "normal" },
    57: { name: "57. Spaghetti Nussknacker", preis: 9.50, type: "normal" },
    58: { name: "58. Spaghetti Amarena", preis: 8.90, type: "normal" },
    59: { name: "59. Spaghetti Waldfr√ºchte", preis: 8.90, type: "normal" },
    60: { name: "60. Spaghetti Melone", preis: 8.90, type: "normal" },
    61: { name: "61. Spaghetti Tutti Frutti", preis: 8.90, type: "normal" },
    62: { name: "62. Lasagne Eis", preis: 8.90, type: "normal" },

    63: { name: "63. Pizza Margherita", preis: 9.00, type: "normal" },
    64: { name: "64. Pizza Grandiosa", preis: 12.00, type: "normal" },

    70: { name: "70. Mixgetr√§nk Spezial", preis: 6.50, type: "normal" },
    71: { name: "71. Joghurrette Becher", preis: 9.50, type: "normal" },
    72: { name: "72. Joghurt Cocktail", preis: 9.50, type: "normal" },
    73: { name: "73. Joghurt Kiwi", preis: 9.00, type: "normal" },
    74: { name: "74. Joghurt Erdbeere", preis: 9.00, type: "normal" },
    75: { name: "75. Joghurt Ananas", preis: 9.00, type: "normal" },
    76: { name: "76. M√ºsli Joghurt Becher", preis: 9.00, type: "normal" },
    77: { name: "77. Joghurt Heidelbeere", preis: 9.00, type: "normal" },
    78: { name: "78. Joghurt Banane", preis: 9.00, type: "normal" },
    79: { name: "79. Joghurt Amarena", preis: 9.00, type: "normal" },
    80: { name: "80. Joghurt Himbeere", preis: 9.00, type: "normal" },

    81: { name: "81. Hei√üe Kirschen", preis: 8.50, type: "normal" },
    82: { name: "82. Hei√üe Himbeeren", preis: 9.00, type: "normal" },
    83: { name: "83. Zimt Becher", preis: 8.50, type: "normal" },
    84: { name: "84. Cup D√§nemark", preis: 8.50, type: "normal" },
    85: { name: "85. Wiener Mokka", preis: 8.50, type: "normal" },

    90: { name: "90. Amaretto Becher", preis: 8.50, type: "normal" },
    91: { name: "91. Schwarzwald Becher", preis: 9.00, type: "normal" },
    92: { name: "92. Malaga Becher", preis: 9.00, type: "normal" },
    93: { name: "93. Mon Ch√©ri Becher", preis: 9.50, type: "normal" },
    94: { name: "94. Raffaello Becher", preis: 9.50, type: "normal" },
    96: { name: "96. Eierlik√∂r Becher", preis: 8.50, type: "normal" },
    98: { name: "98. Nuss Becher", preis: 9.50, type: "normal" },
    99: { name: "99. Rocher Becher", preis: 9.50, type: "normal" },
    100:{ name: "100. Giotto Becher", preis: 9.00, type: "normal" },
    101:{ name: "101. Berg Becher", preis: 10.50, type: "normal" },
    102:{ name: "102. Walnuss Becher", preis: 9.50, type: "normal" },
    103:{ name: "103. Coppa Delizia", preis: 10.90, type: "normal" },

    110:{ name: "110. After Eight Becher", preis: 8.90, type: "normal" },
    111:{ name: "111. Stracciatella Becher", preis: 7.90, type: "normal" },
    112:{ name: "112. Tartufo Nero", preis: 9.50, type: "normal" },
    113:{ name: "113. Tartufo Bianco", preis: 9.50, type: "normal" },
    114:{ name: "114. Hausbecher", preis: 20.00, type: "normal" },
    116:{ name: "116. Krokant Becher", preis: 8.50, type: "normal" },
    117:{ name: "117. Schoko Becher", preis: 8.50, type: "normal" },
    118:{ name: "118. Schoko Becher gro√ü", preis: 12.00, type: "normal" },
    122:{ name: "122. Pistazien Becher", preis: 11.50, type: "normal" },

    130:{ name: "130. Flipper", preis: 5.00, type: "normal" },
    131:{ name: "131. Bellini", preis: 6.00, type: "normal" },
    132:{ name: "132. Mimosa", preis: 6.00, type: "normal" },
    133:{ name: "133. Formula 1", preis: 6.00, type: "normal" },
    134:{ name: "134. Formula 2", preis: 6.00, type: "normal" },

    140:{ name: "140. Eiskaffee", preis: 5.50, type: "normal" },
    141:{ name: "141. Eisschokolade", preis: 5.50, type: "normal" },
    142:{ name: "142. Eis-Cappuccino", preis: 5.50, type: "normal" },

    150:{ name: "150. Milch-Mix 0,3 l", preis: 4.00, type: "normal" },
    151:{ name: "151. Milchshake 0,3 l", preis: 4.60, type: "normal" },
    152:{ name: "152. Riesen Milch-Mix 0,5 l", preis: 5.00, type: "normal" },
    153:{ name: "153. Riesen Milchshake 0,5 l", preis: 5.50, type: "normal" },
    154:{ name: "154. Vulcano", preis: 3.70, type: "normal" },
    155:{ name: "155. Orangensaft (frisch)", preis: 4.50, type: "normal" },
    156:{ name: "156. Kalte Zitrone", preis: 3.50, type: "normal" },

    160:{ name: "Erdbeer Donut", preis: 6.90, type: "normal" },
    161:{ name: "Schoko Donut", preis: 6.90, type: "normal" },
    162:{ name: "Caramel Donut", preis: 6.90, type: "normal" },
    163:{ name: "Pistazien Donut", preis: 7.20, type: "normal" },
    164:{ name: "Kinder Donut", preis: 6.50, type: "normal" },

    200:{ name: "Espresso", preis: 2.00, type: "normal" },
    201:{ name: "Espresso Macchiato", preis: 2.30, type: "normal" },
    202:{ name: "Espresso Corretto", preis: 3.40, type: "normal" },
    203:{ name: "Doppelter Espresso", preis: 3.60, type: "normal" },
    204:{ name: "Doppelter Espresso Macchiato", preis: 3.80, type: "normal" },
    210:{ name: "Kaffee", preis: 2.20, type: "normal" },
    220:{ name: "Milchkaffee", preis: 3.00, type: "normal" },
    221:{ name: "Milchkaffee mit Baileys", preis: 4.00, type: "normal" },
    230:{ name: "Latte Macchiato", preis: 3.60, type: "normal" },
    231:{ name: "Latte Macchiato mit Sirup", preis: 3.20, type: "normal" },
    240:{ name: "Cappuccino", preis: 2.60, type: "normal" },
    241:{ name: "Cappuccino gro√ü", preis: 3.00, type: "normal" },
    244:{ name: "Cappuccino mit Amaretto", preis: 4.00, type: "normal" },
    245:{ name: "Cappuccino mit Eierlik√∂r", preis: 4.00, type: "normal" },
    246:{ name: "Cappuccino mit Baileys", preis: 4.00, type: "normal" },

    300:{ name: "Coca-Cola 0,2 l", preis: 2.70, type: "normal" },
    301:{ name: "Coca-Cola Light 0,2 l", preis: 2.70, type: "normal" },
    302:{ name: "Coca-Cola Zero 0,2 l", preis: 2.70, type: "normal" },
    303:{ name: "Fanta 0,2 l", preis: 2.70, type: "normal" },
    304:{ name: "Mezzo Mix 0,2 l", preis: 2.70, type: "normal" },
    305:{ name: "Sprite 0,2 l", preis: 2.70, type: "normal" },
    306:{ name: "Bitter Lemon 0,2 l", preis: 2.70, type: "normal" },
    307:{ name: "Apfelschorle", preis: 1.90, type: "normal" },
    308:{ name: "Eistee", preis: 1.90, type: "normal" },
    309:{ name: "Wild Berry", preis: 2.20, type: "normal" },
    310:{ name: "Tonic Water", preis: 2.20, type: "normal" },
    311:{ name: "S.Pellegrino 0,25 l", preis: 2.40, type: "normal" },
    312:{ name: "S.Pellegrino 0,75 l", preis: 5.90, type: "normal" },

    350:{ name: "Krombacher Pils 0,33 l", preis: 2.80, type: "normal" },
    351:{ name: "Krombacher Radler 0,33 l", preis: 2.80, type: "normal" },
    352:{ name: "Erdinger Wei√übier 0,5 l", preis: 4.50, type: "normal" },
    353:{ name: "Erdinger Alkoholfrei 0,33 l", preis: 2.80, type: "normal" },
    354:{ name: "Erdinger Alkoholfrei 0,5 l", preis: 4.50, type: "normal" },

    400:{ name: "Rotwein trocken 0,2 l", preis: 4.90, type: "normal" },
    401:{ name: "Wei√üwein trocken 0,2 l", preis: 4.90, type: "normal" },
    402:{ name: "Glas Sekt", preis: 3.90, type: "normal" },
    403:{ name: "Campari Sekt", preis: 3.90, type: "normal" },
    410:{ name: "Aperitif Rosato", preis: 5.90, type: "normal" },
    430:{ name: "Grappa", preis: 4.70, type: "normal" },
    431:{ name: "Asbach", preis: 3.20, type: "normal" },
    432:{ name: "Ramazzotti", preis: 3.20, type: "normal" },
    433:{ name: "Aperol", preis: 6.10, type: "normal" },
    434:{ name: "Hugo", preis: 6.10, type: "normal" },

    500:{ name: "Flammkuchen Els√§sser Art", preis: 8.90, type: "normal" },
    501:{ name: "Flammkuchen Wildlachs & Shrimps", preis: 8.90, type: "normal" },
    502:{ name: "Flammkuchen Griechische Art", preis: 8.90, type: "normal" },
    510:{ name: "Toast mit K√§se", preis: 3.70, type: "normal" },
    511:{ name: "Toast mit K√§se & Schinken", preis: 4.30, type: "normal" },
    512:{ name: "Toast mit Salami & K√§se", preis: 4.30, type: "normal" },
    513:{ name: "Toast Hawaii", preis: 5.60, type: "normal" },
    520:{ name: "Baguette XXL", preis: 6.90, type: "normal" },

    600:{ name: "Apfelstrudel", preis: 3.70, type: "normal" },
    601:{ name: "Apfelstrudel mit Vanilleso√üe", preis: 4.00, type: "normal" },
    602:{ name: "Apfelstrudel mit Sahne", preis: 4.70, type: "normal" },
    603:{ name: "Apfelstrudel mit Eis", preis: 6.10, type: "normal" },
    610:{ name: "Hausgemachtes Tiramisu", preis: 4.20, type: "normal" },
    620:{ name: "Waffel mit Puderzucker", preis: 4.00, type: "normal" },
    621:{ name: "Waffel mit Sahne", preis: 5.00, type: "normal" },
    622:{ name: "Waffel mit Eis", preis: 5.30, type: "normal" },
    623:{ name: "Waffel mit Eis & Sahne", preis: 6.30, type: "normal" },
    624:{ name: "Waffel mit Nutella", preis: 5.00, type: "normal" },

    631:{ name: "630a. Waffel Zimt & Banane", preis: 6.80, type: "normal" },
    632:{ name: "630b. Waffel Obstsalat", preis: 7.90, type: "normal" },
    633:{ name: "630c. Waffel Erdbeeren", preis: 7.50, type: "normal" },
    634:{ name: "630d. Waffel Waldbeeren", preis: 7.20, type: "normal" },
    635:{ name: "630e. Waffel Schoko-Banane", preis: 7.90, type: "normal" },
    636:{ name: "630f. Waffel Hei√üe Kirschen", preis: 7.00, type: "normal" },
    637:{ name: "630g. Waffel Schoko", preis: 6.80, type: "normal" },
    638:{ name: "630h. Waffel Tutti Frutti", preis: 7.50, type: "normal" }
};

/* IDs que t√™m op√ß√£o de Sahne por padr√£o */
const SAHNE_DEFAULT_IDS = new Set([
    23, 24, 25, 26,
    30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,
    81,82,83,84,85,
    90,91,92,93,94,96,98,99,100,101,102,103,
    110,111,112,113,114,116,117,118,122,
    50,51,52,53,54,55,56,57,58,59,60,61,62,
    63,64,
    70,71,72,73,74,75,76,77,78,79,80,
    160,161,162,163,164,
    130,131,132,133,134,
    140,141,142,
    150,151,152,153,154,155,156,
    600,601,602,603,
    610,
    620,621,622,623,624,
    631,632,633,634,635,636,637,638
]);

/* Grupos base (tabs) */
const DEFAULT_GROUPS = {
    portions: [23,24,25,26],
    kids: [23,160,161,162,163,164,130,154,150,151,152,153],
    eis: [
        30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,
        50,51,52,53,54,55,56,57,58,59,60,61,62,
        70,71,72,73,74,75,76,77,78,79,80,
        81,82,83,84,85,
        90,91,92,93,94,96,98,99,100,101,102,103,
        110,111,112,113,114,116,117,118,122
    ],
    food: [
        500,501,502,
        510,511,512,513,
        520,
        600,601,602,603,
        610,
        620,621,622,623,624,
        631,632,633,634,635,636,637,638
    ],
    drinks: [
        140,141,142,
        150,151,152,153,154,155,156,
        200,201,202,203,204,
        210,220,221,
        230,231,
        240,241,244,245,246,
        300,301,302,303,304,305,306,307,308,309,310,311,312,
        350,351,352,353,354,
        400,401,402,403,410,
        430,431,432,433,434
    ]
};

const GROUP_LABELS = {
    portions: "Portionen",
    kids: "Kinder",
    eis: "Eisbecher & Spaghetti",
    food: "Snacks & Waffeln",
    drinks: "Getr√§nke"
};

/* Sortenliste (para Portionen) */
const SORTEN = [
    "Vanille","Amarena","Joghurt","Nuss","Schokolade","Stracciatella",
    "After Eight","Schlumpfeis","Malaga","Walnuss","Cookies","Zitrone",
    "Erdbeere","Mango","Banane","Himbeere","Limette",
    "Dunkle Schokolade","Paw Patrol","Snickers","Pistazien"
];

/* =================== FUN√á√ïES DE MENU / CONFIG =================== */

function buildDefaultMenuData() {
    const products = {};
    Object.keys(DEFAULT_PRODUCTS).forEach(idStr => {
        const base = DEFAULT_PRODUCTS[idStr];
        const idNum = parseInt(idStr, 10);
        products[idStr] = {
            id: idNum,
            name: base.name,
            price: base.preis,
            type: base.type,          // "normal" ou "cup3"
            hasSahne: SAHNE_DEFAULT_IDS.has(idNum),
            active: true
        };
    });

    const groups = {};
    Object.keys(DEFAULT_GROUPS).forEach(g => {
        groups[g] = DEFAULT_GROUPS[g].map(id => String(id));
    });

    return {
        products,
        groups,
        nextId: 1000
    };
}

function loadMenuData() {
    try {
        const raw = localStorage.getItem("sanremo_menu_config");
        if (raw) {
            menuData = JSON.parse(raw);
            return;
        }
    } catch(e) {
        console.warn("Fehler beim Laden des Men√ºs, benutze Standardwerte.", e);
    }
    menuData = buildDefaultMenuData();
}

function saveMenuData() {
    try {
        localStorage.setItem("sanremo_menu_config", JSON.stringify(menuData));
    } catch(e) {
        console.warn("Konnte Men√º-Konfiguration nicht speichern.", e);
    }
}

/* =================== ADMIN ORDERS (HIST√ìRICO) =================== */

function loadAdminOrders() {
    try {
        const raw = localStorage.getItem("sanremo_order_log");
        if (raw) {
            adminOrders = JSON.parse(raw);
        } else {
            adminOrders = [];
        }
    } catch(e) {
        console.warn("Fehler beim Laden der Bestellhistorie.", e);
        adminOrders = [];
    }
}

function saveAdminOrders() {
    try {
        localStorage.setItem("sanremo_order_log", JSON.stringify(adminOrders));
    } catch(e) {
        console.warn("Konnte Bestellhistorie nicht speichern.", e);
    }
}

/* =================== HELPERS =================== */

function escapeHtml(str) {
    return String(str)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;");
}

/* =================== UI INICIAL =================== */

function initTische() {
    const tischSelect = document.getElementById("tisch");
    for (let i = 1; i <= 33; i++) {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = "Tisch " + i;
        tischSelect.appendChild(opt);
    }
}

function initSorten() {
    ["geschmack1", "geschmack2", "geschmack3"].forEach(id => {
        const sel = document.getElementById(id);
        sel.innerHTML = "<option value=''>Sorte w√§hlen‚Ä¶</option>";
        SORTEN.forEach(s => {
            const opt = document.createElement("option");
            opt.value = s;
            opt.textContent = s;
            sel.appendChild(opt);
        });
    });
}

/* Preenche select de produto com base na categoria */
function buildProduktSelect(group) {
    const select = document.getElementById("produkt");
    select.innerHTML = "<option value=''>Bitte w√§hlen‚Ä¶</option>";
    const ids = (menuData.groups[group] || []);
    ids.forEach(idStr => {
        const p = menuData.products[idStr];
        if (!p || !p.active) return;
        const opt = document.createElement("option");
        opt.value = idStr;
        opt.textContent = p.name + " ‚Äì " + p.price.toFixed(2).replace(".", ",") + " ‚Ç¨";
        select.appendChild(opt);
    });

    document.getElementById("geschmack-box").style.display = "none";
    document.getElementById("sahne-box").style.display = "none";
    ["geschmack1","geschmack2","geschmack3"].forEach(id=>{
        document.getElementById(id).value = "";
    });
    document.getElementById("sahne").value = "";
    document.getElementById("bemerkung").value = "";
}

/* Tabs */
function initTabs() {
    document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            currentGroup = btn.dataset.group;
            document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            buildProduktSelect(currentGroup);
        });
    });
}

/* Produto change ‚Äì mostra Sorten / Sahne */
function initProduktChange() {
    document.getElementById("produkt").addEventListener("change", function() {
        const wert = this.value;
        const geschmackBox = document.getElementById("geschmack-box");
        const sahneBox = document.getElementById("sahne-box");

        if (!wert || !menuData.products[wert]) {
            geschmackBox.style.display = "none";
            sahneBox.style.display = "none";
            document.getElementById("sahne").value = "";
            return;
        }

        const p = menuData.products[wert];

        if (p.type === "cup3") {
            geschmackBox.style.display = "block";
        } else {
            geschmackBox.style.display = "none";
            ["geschmack1", "geschmack2", "geschmack3"].forEach(id => {
                const sel = document.getElementById(id);
                if (sel) sel.value = "";
            });
        }

        if (p.hasSahne) {
            sahneBox.style.display = "block";
        } else {
            sahneBox.style.display = "none";
            document.getElementById("sahne").value = "";
        }
    });
}

/* =================== WARENKORB =================== */

function addToCart() {
    const tisch = document.getElementById("tisch").value;
    if (!tisch) {
        alert("Bitte zuerst den Tisch ausw√§hlen.");
        return;
    }

    const produktId = document.getElementById("produkt").value;
    if (!produktId || !menuData.products[produktId]) {
        alert("Bitte ein Produkt ausw√§hlen.");
        return;
    }

    const produkt = menuData.products[produktId];
    let sorten = [];
    const bemerkung = document.getElementById("bemerkung").value.trim();

    if (produkt.type === "cup3") {
        const s1 = document.getElementById("geschmack1").value;
        const s2 = document.getElementById("geschmack2").value;
        const s3 = document.getElementById("geschmack3").value;
        if (s1) sorten.push(s1);
        if (s2) sorten.push(s2);
        if (s3) sorten.push(s3);
    }

    let sahne = "";
    if (produkt.hasSahne) {
        sahne = document.getElementById("sahne").value;
    }

    warenkorb.push({
        id: produktId,
        name: produkt.name,
        price: produkt.price,
        type: produkt.type,
        sorten: sorten,
        bemerkung: bemerkung,
        sahne: sahne
    });

    document.getElementById("bemerkung").value = "";
    if (produkt.type === "cup3") {
        ["geschmack1", "geschmack2", "geschmack3"].forEach(id => {
            document.getElementById(id).value = "";
        });
    }
    document.getElementById("produkt").value = "";
    document.getElementById("sahne").value = "";

    updateCart();
}

function updateCart() {
    const liste = document.getElementById("liste-items");
    const totalDiv = document.getElementById("gesamt");
    const btnWpp = document.getElementById("btn-whatsapp");
    const btnPrint = document.getElementById("btn-print");

    liste.innerHTML = "";
    let total = 0;

    warenkorb.forEach((item, index) => {
        total += item.price;

        const line = document.createElement("div");
        line.className = "line-item";

        const info = document.createElement("div");
        info.className = "item-info";

        let text = item.name + " ‚Äì " + item.price.toFixed(2).replace(".", ",") + " ‚Ç¨";
        if (item.type === "cup3" && item.sorten.length > 0) {
            text += "<br><span class='small'>Sorten: " + item.sorten.join(", ") + "</span>";
        }
        if (item.bemerkung) {
            text += "<br><span class='small'>Bemerkung: " + item.bemerkung + "</span>";
        }
        if (item.sahne) {
            text += "<br><span class='small'>Sahne: " + item.sahne + "</span>";
        }
        info.innerHTML = text;

        const btnRemove = document.createElement("button");
        btnRemove.className = "btn-remove";
        btnRemove.textContent = "X";
        btnRemove.onclick = () => removeItem(index);

        line.appendChild(info);
        line.appendChild(btnRemove);
        liste.appendChild(line);
    });

    totalDiv.textContent = "Gesamt: " + total.toFixed(2).replace(".", ",") + " ‚Ç¨";
    const hasItems = warenkorb.length > 0;
    btnWpp.disabled = !hasItems || !gpsOk;
    btnPrint.disabled = !hasItems;
}

function removeItem(index) {
    warenkorb.splice(index, 1);
    updateCart();
}

/* Texto da encomenda (plain text) */
function buildOrderText() {
    const tisch = document.getElementById("tisch").value || "-";
    let total = 0;
    let text = `Tisch ${tisch} - Bestellung:\n`;

    warenkorb.forEach(item => {
        total += item.price;
        let line = `‚Ä¢ ${item.name} (${item.price.toFixed(2)} ‚Ç¨)`;
        if (item.type === "cup3" && item.sorten.length > 0) {
            line += ` ‚Äì Sorten: ${item.sorten.join(", ")}`;
        }
        if (item.bemerkung) {
            line += ` ‚Äì Bemerkung: ${item.bemerkung}`;
        }
        if (item.sahne) {
            line += ` ‚Äì Sahne: ${item.sahne}`;
        }
        text += line + "\n";
    });

    text += `\nGesamtbetrag: ${total.toFixed(2)} ‚Ç¨`;
    return text;
}

/* Guardar pedido para o Chef */
function storeOrder(channel) {
    const tisch = document.getElementById("tisch").value || "-";
    const textPlain = buildOrderText();
    const timestamp = new Date().toLocaleString("de-DE");
    adminOrders.push({ tisch, channel, text: textPlain, time: timestamp });
    saveAdminOrders();
    if (isAdmin) updateAdminList();
}

/* =================== WHATSAPP & DRUCKEN =================== */

function sendWhatsApp() {
    if (!gpsOk) {
        alert("Bestellung nur vor Ort m√∂glich. Bitte Standort-Freigabe erlauben.");
        return;
    }

    const tisch = document.getElementById("tisch").value;
    if (!tisch) {
        alert("Bitte zuerst den Tisch ausw√§hlen.");
        return;
    }
    if (warenkorb.length === 0) {
        alert("Der Warenkorb ist leer.");
        return;
    }

    storeOrder("WhatsApp");
    const text = encodeURIComponent(buildOrderText());
    const url = `https://wa.me/${WHATSAPP_NUMMER}?text=${text}`;
    window.open(url, "_blank");

    warenkorb = [];
    updateCart();
}

function printOrder() {
    if (warenkorb.length === 0) {
        alert("Der Warenkorb ist leer.");
        return;
    }
    const tisch = document.getElementById("tisch").value || "-";
    const textHtml = buildOrderText().replace(/\n/g, "<br>");

    storeOrder("Drucker");

    const win = window.open("", "_blank");
    win.document.open();
    win.document.write(`
        <html>
        <head>
            <title>Bestellung Tisch ${tisch}</title>
            <meta charset="UTF-8">
        </head>
        <body style="font-family:Arial,sans-serif; font-size:14px;">
            <h2>Bestellung Tisch ${tisch}</h2>
            <p>${textHtml}</p>
        </body>
        </html>
    `);
    win.document.close();
    win.print();
}

/* =================== RESET =================== */

function resetTable() {
    if (!confirm("M√∂chten Sie den Tisch wirklich zur√ºcksetzen? Alle Bestellungen werden gel√∂scht.")) {
        return;
    }

    warenkorb = [];
    updateCart();

    const tischSel = document.getElementById("tisch");
    if (tischSel) tischSel.value = "";

    const produktSel = document.getElementById("produkt");
    if (produktSel) produktSel.value = "";

    ["geschmack1", "geschmack2", "geschmack3"].forEach(id => {
        const sel = document.getElementById(id);
        if (sel) sel.value = "";
    });

    const sahneSel = document.getElementById("sahne");
    if (sahneSel) sahneSel.value = "";

    document.getElementById("bemerkung").value = "";
}

/* =================== GPS =================== */

function deg2rad(deg) { return deg * (Math.PI / 180); }

function distanceKm(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = deg2rad(lat2 - lat1);
    const dLon = deg2rad(lon2 - lon1);
    const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}

function initLocation() {
    const info = document.getElementById("gps-info");
    const btnWpp = document.getElementById("btn-whatsapp");

    if (!navigator.geolocation) {
        info.textContent = "GPS nicht verf√ºgbar ‚Äì Bestellung per WhatsApp ist deaktiviert.";
        gpsOk = false;
        btnWpp.disabled = true;
        return;
    }

    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const dist = distanceKm(lat, lng, CAFE_LAT, CAFE_LNG);

            if (dist <= MAX_DIST_KM) {
                gpsOk = true;
                info.textContent = "Standort OK ‚Äì Bestellung per WhatsApp ist m√∂glich.";
            } else {
                gpsOk = false;
                info.textContent = "Sie sind zu weit vom Standort entfernt ‚Äì Bestellung per WhatsApp nicht m√∂glich.";
            }
            updateCart();
        },
        (err) => {
            gpsOk = false;
            info.textContent = "Standort konnte nicht bestimmt werden ‚Äì bitte GPS erlauben.";
            btnWpp.disabled = true;
        }
    );
}

/* =================== CHEF LOGIN & ADMIN PANEL =================== */

function adminLogin() {
    const pw = document.getElementById("admin-password").value;
    if (pw === ADMIN_PASSWORD) {
        isAdmin = true;
        document.getElementById("admin-login-card").style.display = "none";
        document.getElementById("admin-panel").style.display = "block";
        updateAdminList();
        initAdminGroupSelect();
        renderAdminProducts();
    } else {
        alert("Falsches Passwort.");
    }
}

function adminLogout() {
    isAdmin = false;
    document.getElementById("admin-panel").style.display = "none";
    document.getElementById("admin-login-card").style.display = "block";
    document.getElementById("admin-password").value = "";
}

function updateAdminList() {
    const list = document.getElementById("admin-orders-list");
    list.innerHTML = "";
    if (adminOrders.length === 0) {
        list.innerHTML = "<div class='small'>Noch keine Bestellungen gespeichert.</div>";
        return;
    }

    adminOrders.forEach((o, idx) => {
        const div = document.createElement("div");
        div.className = "admin-order";
        div.innerHTML = `
            <strong>${escapeHtml(o.time)}</strong> ‚Äì Tisch ${escapeHtml(o.tisch)} (${escapeHtml(o.channel)})<br>
            ${escapeHtml(o.text).replace(/\n/g,"<br>")}
            <br>
            <button class="btn-small" onclick="deleteOrder(${idx})">L√∂schen</button>
        `;
        list.appendChild(div);
    });
}

function deleteOrder(index) {
    adminOrders.splice(index, 1);
    saveAdminOrders();
    updateAdminList();
}

function clearAllOrders() {
    if (!confirm("Alle gespeicherten Bestellungen wirklich l√∂schen?")) return;
    adminOrders = [];
    saveAdminOrders();
    updateAdminList();
}

/* =================== ADMIN ‚Äì PRODUKTE & PREISE =================== */

function initAdminGroupSelect() {
    const sel = document.getElementById("admin-group-select");
    sel.innerHTML = "";
    Object.keys(GROUP_LABELS).forEach(key => {
        const opt = document.createElement("option");
        opt.value = key;
        opt.textContent = GROUP_LABELS[key];
        sel.appendChild(opt);
    });
    sel.value = currentGroup || "portions";
    sel.onchange = () => renderAdminProducts();
}

function renderAdminProducts() {
    const group = document.getElementById("admin-group-select").value;
    const container = document.getElementById("admin-products-editor");
    const ids = menuData.groups[group] || [];

    if (ids.length === 0) {
        container.innerHTML = "<div class='small'>Keine Produkte in dieser Kategorie.</div>";
        return;
    }

    let html = `
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Aktiv</th>
                    <th>Name</th>
                    <th>Preis (‚Ç¨)</th>
                    <th>Art</th>
                    <th>Sahne</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
    `;

    ids.forEach(idStr => {
        const p = menuData.products[idStr];
        if (!p) return;
        html += `
            <tr data-id="${idStr}">
                <td style="text-align:center;">
                    <input type="checkbox" class="admin-active" ${p.active ? "checked" : ""}>
                </td>
                <td>
                    <input type="text" class="admin-name" value="${escapeHtml(p.name)}">
                </td>
                <td>
                    <input type="number" step="0.10" class="admin-price" value="${p.price.toFixed(2)}">
                </td>
                <td>
                    <select class="admin-type">
                        <option value="normal" ${p.type === "normal" ? "selected" : ""}>Normal</option>
                        <option value="cup3" ${p.type === "cup3" ? "selected" : ""}>Portion (mit Sorten)</option>
                    </select>
                </td>
                <td style="text-align:center;">
                    <input type="checkbox" class="admin-sahne" ${p.hasSahne ? "checked" : ""}>
                </td>
                <td style="text-align:right;">
                    <button type="button" class="btn-small admin-remove">X</button>
                </td>
            </tr>
        `;
    });

    html += "</tbody></table>";
    container.innerHTML = html;

    container.querySelectorAll(".admin-remove").forEach(btn => {
        btn.addEventListener("click", () => {
            const tr = btn.closest("tr");
            const id = tr.getAttribute("data-id");
            adminRemoveProductFromGroup(group, id);
        });
    });
}

/* Remove produto da categoria (e de outras se quiseres) */
function adminRemoveProductFromGroup(group, idStr) {
    if (!confirm("Dieses Produkt aus dieser Kategorie entfernen?")) return;

    Object.keys(menuData.groups).forEach(g => {
        menuData.groups[g] = menuData.groups[g].filter(x => x !== idStr);
    });

    // se n√£o estiver em mais nenhuma categoria, apaga completamente
    let stillUsed = false;
    Object.values(menuData.groups).forEach(arr => {
        if (arr.includes(idStr)) stillUsed = true;
    });
    if (!stillUsed) {
        delete menuData.products[idStr];
    }

    saveMenuData();
    renderAdminProducts();
    buildProduktSelect(currentGroup);
}

/* Adicionar novo produto √† categoria atual */
function adminAddProduct() {
    const group = document.getElementById("admin-group-select").value;
    if (!group) return;

    const newIdNum = menuData.nextId || 1000;
    menuData.nextId = newIdNum + 1;
    const idStr = String(newIdNum);

    menuData.products[idStr] = {
        id: newIdNum,
        name: "Neues Produkt",
        price: 0,
        type: (group === "portions" ? "cup3" : "normal"),
        hasSahne: (group === "portions" || group === "kids" || group === "eis" || group === "food"),
        active: true
    };

    if (!menuData.groups[group]) menuData.groups[group] = [];
    menuData.groups[group].push(idStr);

    saveMenuData();
    renderAdminProducts();
    buildProduktSelect(currentGroup);
}

/* Guardar altera√ß√µes feitas no editor */
function adminSaveProducts() {
    const group = document.getElementById("admin-group-select").value;
    const container = document.getElementById("admin-products-editor");
    const rows = container.querySelectorAll("tr[data-id]");

    const newOrder = [];
    rows.forEach(tr => {
        const idStr = tr.getAttribute("data-id");
        const p = menuData.products[idStr];
        if (!p) return;

        const active = tr.querySelector(".admin-active").checked;
        const name = tr.querySelector(".admin-name").value.trim() || "Unbenannt";
        const priceStr = tr.querySelector(".admin-price").value.replace(",", ".");
        let price = parseFloat(priceStr);
        if (isNaN(price) || price < 0) price = 0;

        const typeVal = tr.querySelector(".admin-type").value === "cup3" ? "cup3" : "normal";
        const hasSahne = tr.querySelector(".admin-sahne").checked;

        p.active = active;
        p.name = name;
        p.price = price;
        p.type = typeVal;
        p.hasSahne = hasSahne;

        newOrder.push(idStr);
    });

    menuData.groups[group] = newOrder;
    saveMenuData();
    buildProduktSelect(currentGroup);
    alert("Produkte gespeichert.");
}

/* =================== ON LOAD =================== */

window.addEventListener("load", () => {
    loadMenuData();
    loadAdminOrders();

    initTische();
    initSorten();
    initTabs();
    initProduktChange();

    buildProduktSelect(currentGroup);
    updateCart();
    initLocation();
});
</script>

</body>
</html>
